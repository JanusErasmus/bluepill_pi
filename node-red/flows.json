[{"id":"8e3dae77.2b0e1","type":"tab","label":"NodeMQTT","disabled":false,"info":""},{"id":"983d8884.0e0c58","type":"tab","label":"Telegram","disabled":false,"info":""},{"id":"8d9e59c5.1bb608","type":"tab","label":"Graphs","disabled":false,"info":""},{"id":"acf214e0.5d8368","type":"subflow","name":"TX Telegram","info":"","category":"","in":[{"x":540,"y":160,"wires":[{"id":"de6aedb9.d1f99"}]}],"out":[]},{"id":"c0d7e3a7.9516f","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Erasmus Home","hideToolbar":"false","allowSwipe":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":60,"sy":60,"gx":6,"gy":6,"cx":6,"cy":6,"px":1,"py":1},"lockMenu":"false"}},{"id":"4a731906.628d48","type":"mqtt-broker","z":"","name":"","broker":"localhost","port":"1883","clientid":"JanusVPS","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"a7800071.8aa72","type":"ui_group","z":"","name":"Home","tab":"1c979d26.9d96c3","order":2,"disp":true,"width":"6","collapse":false},{"id":"1c979d26.9d96c3","type":"ui_tab","z":"","name":"Erasmus Home","icon":"dashboard"},{"id":"2f4e5a55.3805d6","type":"telegram bot","z":"","botname":"janus_vps_bot","usernames":"janus_erasmus","chatids":"","baseapiurl":"","pollinterval":"300","usesocks":false,"sockshost":"","socksport":"","socksusername":"","sockspassword":"","bothost":"","localbotport":"","publicbotport":"","privatekey":"","certificate":"","useselfsignedcertificate":false,"verboselogging":false},{"id":"9818fae6.808138","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"erasmus_home","name":"","usetls":false,"tls":""},{"id":"c0798c8e.d32c5","type":"ui_tab","z":"","name":"Fermenter","icon":"dashboard","order":2,"disabled":false,"hidden":false},{"id":"b88984f.d6a7478","type":"ui_group","z":"","name":"Temperature","tab":"c0798c8e.d32c5","order":1,"disp":true,"width":"6","collapse":false},{"id":"f3ed241f.996fa8","type":"mqtt in","z":"8e3dae77.2b0e1","name":"","topic":"/node/up/+","qos":"2","datatype":"auto","broker":"4a731906.628d48","x":120,"y":320,"wires":[["a90c6a26.868bb8","deecbbf2.74ffb8"]]},{"id":"b76775bd.27e518","type":"debug","z":"8e3dae77.2b0e1","name":"JSON","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":490,"y":260,"wires":[]},{"id":"deecbbf2.74ffb8","type":"function","z":"8e3dae77.2b0e1","name":"parseString","func":"msg.payload = JSON.parse(msg.payload);\n\nif(msg.payload.uptime < 0){\n    msg.payload.uptime = (-1*msg.payload.uptime) + 2147483648\n}\n\nmsg.payload.node = msg.topic.split('/')[3]\n\ninflux = {}\ninflux.payload = [\n    {\n    \"uptime\":msg.payload.uptime,\n    \"T\":msg.payload.temperature / 1000,\n    \"V0\":msg.payload.voltages[0],\n    \"V1\":msg.payload.voltages[1],\n    \"V2\":msg.payload.voltages[2],\n    \"V3\":msg.payload.voltages[3],\n    \"In\":msg.payload.inputs,\n    \"Out\":msg.payload.inputs\n    },\n    {\"id\":msg.payload.node\n    }\n]\n\nreturn [msg, influx];","outputs":2,"noerr":0,"x":310,"y":340,"wires":[["b76775bd.27e518","cf1b1e9a.65ffb"],["89514d16.e5e29"]]},{"id":"c16166b6.8fc318","type":"mqtt out","z":"983d8884.0e0c58","name":"","topic":"","qos":"","retain":"","broker":"4a731906.628d48","x":990,"y":260,"wires":[]},{"id":"76a8db9a.e81884","type":"function","z":"983d8884.0e0c58","name":"Request all nodes to report","func":"msg = {}\nmsg.topic = \"/node/down/255\";\nmsg.payload = \"report\";\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":260,"wires":[["c16166b6.8fc318"]]},{"id":"f6bdab86.895d78","type":"telegram event","z":"983d8884.0e0c58","name":"Event","bot":"2f4e5a55.3805d6","event":"callback_query","autoanswer":"","x":130,"y":300,"wires":[["59c50f12.7dc56"]]},{"id":"a4e1d758.715558","type":"telegram sender","z":"983d8884.0e0c58","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":710,"y":180,"wires":[[]]},{"id":"59c50f12.7dc56","type":"switch","z":"983d8884.0e0c58","name":"Answer","property":"payload.content","propertyType":"msg","rules":[{"t":"eq","v":"OPT STATUS","vt":"str"},{"t":"eq","v":"OPT SET","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":300,"y":300,"wires":[["d489a649.1ce6b8"],["b290fc3c.fd972"]]},{"id":"d489a649.1ce6b8","type":"function","z":"983d8884.0e0c58","name":"Return status","func":"global.set(\"requested\", true)\nglobal.set(\"requestedFermenter\", true)\nmsg.payload.options = false\nmsg.payload.content = \"Requesting...\"\nreturn [msg, msg];","outputs":2,"noerr":0,"x":510,"y":260,"wires":[["a4e1d758.715558"],["76a8db9a.e81884"]]},{"id":"b290fc3c.fd972","type":"function","z":"983d8884.0e0c58","name":"Reply requests","func":"global.set(\"requested\", true)\nmsg.payload.options = false\nmsg.payload.content = \"Light switch on requested...\"\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":320,"wires":[["52c77317.75f77c","4a6101f9.b0eb2"]]},{"id":"52c77317.75f77c","type":"telegram sender","z":"983d8884.0e0c58","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":710,"y":400,"wires":[[]]},{"id":"94a32c13.ceb9","type":"function","z":"983d8884.0e0c58","name":"Build options","func":"global.set(\"chatId\", msg.payload.chatId)\n\nmsg.payload.type = \"message\"\nmsg.payload.options = {\n    reply_markup: JSON.stringify({\n        inline_keyboard: [\n            [{\n                \"text\":\"Query\",\n                \"callback_data\":\"OPT STATUS\"\n            },\n            {\n                \"text\":\"Lights\",\n                \"callback_data\":\"OPT SET\"\n            }\n            ]\n        ]\n    }),\n    parse_mode : \"Markdown\"\n}\n\nmsg.payload.content = \"**Please select:**\"\n\nreturn msg","outputs":1,"noerr":0,"x":450,"y":80,"wires":[["41d7576d.bf3568"]]},{"id":"ae7f4159.02549","type":"telegram command","z":"983d8884.0e0c58","name":"start","command":"/start","bot":"2f4e5a55.3805d6","x":110,"y":160,"wires":[["94a32c13.ceb9"],[]]},{"id":"41d7576d.bf3568","type":"telegram sender","z":"983d8884.0e0c58","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":710,"y":80,"wires":[[]]},{"id":"cf1b1e9a.65ffb","type":"switch","z":"8e3dae77.2b0e1","name":"Nodes","property":"payload.node","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"},{"t":"eq","v":"4","vt":"str"},{"t":"eq","v":"5","vt":"str"},{"t":"eq","v":"6","vt":"str"},{"t":"eq","v":"7","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":9,"x":490,"y":340,"wires":[["c3af9d7a.46b7f"],["67d944e6.9e618c"],["89bf197a.c847f8"],["89c5402d.96a3b"],["78c222f5.41099c"],["cfdef8a3.db9f48"],["694804a8.d21ffc"],["9b4b86a0.d331c8"],["37913740.4d89c8"]]},{"id":"67d944e6.9e618c","type":"function","z":"8e3dae77.2b0e1","name":"Make UPS message","func":"is_sample = ((msg.payload.inputs & 0x02) === 0x02);\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature / 1000;\nvoltage = msg.payload.voltages[0] / 1000;\ncurrent = (msg.payload.voltages[1] - 32768) / 1000;\nvoltage_230 = msg.payload.voltages[2] / 1000;\ncurrent_230 = (msg.payload.voltages[3] - 32768) / 1000;\n\n\nmains = \"Failure\";\nif((msg.payload.inputs & 0x01) === 0x01)\n    mains = \"OK\";\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*UPS*\" +\n              \"\\nUp time     : \" + upTime + \n              \"\\nTemperature : \" + temp.toFixed(2) + \" C\" +\n              \"\\nMains       : \" + mains +\n              \"\\n12V Voltage : \" + voltage.toFixed(2) + \" V\" +\n              \"\\n12V Current : \" + current.toFixed(3) + \" A\" +\n              \"\\n230V Voltage: \" + voltage_230.toFixed(2) + \" V\" +\n              \"\\n230V Current: \" + current_230.toFixed(3) + \" A\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":260,"wires":[["9f764455.ac1488"]]},{"id":"37913740.4d89c8","type":"function","z":"8e3dae77.2b0e1","name":"Make default message","func":"upTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature / 1000;\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Node:*\" + msg.payload.node +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":500,"wires":[["9f764455.ac1488"]]},{"id":"736a10fe.6407","type":"mqtt in","z":"8e3dae77.2b0e1","name":"","topic":"/pi","qos":"0","datatype":"auto","broker":"4a731906.628d48","x":130,"y":620,"wires":[["1ec8e3ef.7eebfc","edfb7fdf.83d28"]]},{"id":"1ec8e3ef.7eebfc","type":"debug","z":"8e3dae77.2b0e1","name":"Pi status","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":380,"y":600,"wires":[]},{"id":"edfb7fdf.83d28","type":"function","z":"8e3dae77.2b0e1","name":"Prepare message","func":"content = \"Raspberry pi is:\" + msg.payload\n\nmsg.payload = {}\nmsg.payload.chatId =  global.get(\"chatId\");\nmsg.payload.type = \"message\"\nmsg.payload.options = {\"parse_mode\":\"Markdown\"}\nmsg.payload.content = content\n\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":640,"wires":[["f8d5fa85.f52ab8"]]},{"id":"f8d5fa85.f52ab8","type":"telegram sender","z":"8e3dae77.2b0e1","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":670,"y":640,"wires":[[]]},{"id":"b92887c0.dc0648","type":"telegram sender","z":"acf214e0.5d8368","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":970,"y":160,"wires":[[]]},{"id":"de6aedb9.d1f99","type":"function","z":"acf214e0.5d8368","name":"Prepare message","func":"content = msg.payload\n\nmsg.payload = {}\nmsg.payload.chatId =  global.get(\"chatId\");\nmsg.payload.type = \"message\"\nmsg.payload.options = {\"parse_mode\":\"Markdown\"}\nmsg.payload.content = content\n\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":160,"wires":[["b92887c0.dc0648"]]},{"id":"9f764455.ac1488","type":"subflow:acf214e0.5d8368","z":"8e3dae77.2b0e1","name":"","x":1210,"y":380,"wires":[]},{"id":"186cb390.1f3e4c","type":"mqtt out","z":"983d8884.0e0c58","name":"","topic":"","qos":"","retain":"","broker":"4a731906.628d48","x":990,"y":320,"wires":[]},{"id":"4a6101f9.b0eb2","type":"function","z":"983d8884.0e0c58","name":"Set node 0 lights","func":"msg = {}\nmsg.topic = \"/node/down/0\";\nmsg.payload = \"light\";\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":320,"wires":[["186cb390.1f3e4c"]]},{"id":"a90c6a26.868bb8","type":"debug","z":"8e3dae77.2b0e1","name":"Node String","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":330,"y":240,"wires":[]},{"id":"89bf197a.c847f8","type":"function","z":"8e3dae77.2b0e1","name":"Make TV Room message","func":"upTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature / 1000;\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*TV Room*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":300,"wires":[[]]},{"id":"f1c314f.92ff3e8","type":"telegram receiver","z":"983d8884.0e0c58","name":"RX message","bot":"2f4e5a55.3805d6","saveDataDir":"","x":150,"y":500,"wires":[["8fff48b4.4c0f78","a89ace63.1be2","2af14334.72fadc"],[]]},{"id":"a9c689a6.2c53f8","type":"telegram sender","z":"983d8884.0e0c58","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":710,"y":480,"wires":[[]]},{"id":"8fff48b4.4c0f78","type":"function","z":"983d8884.0e0c58","name":"Fermenter Msg","func":"args = msg.payload.content.split(\" \")\n\nif(args.length <= 1)\n    return [null, null];\n\nif(args[0] != \"F\")\n    return [null, null];\n    \nif(isNaN(args[1]))\n    return [null, null];\n    \nmsg.payload.content = \"Setting fermenter setpoint to: \" + args[1]\n\nsetMsg = {};\nsetMsg.payload = args[1];\n\nreturn [msg, setMsg];","outputs":2,"noerr":0,"x":500,"y":500,"wires":[["a9c689a6.2c53f8"],["73151c2f.2d2cd4"]]},{"id":"5af7751.1321b8c","type":"debug","z":"983d8884.0e0c58","name":"Set fermenter","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1020,"y":460,"wires":[]},{"id":"73151c2f.2d2cd4","type":"function","z":"983d8884.0e0c58","name":"Set node 3 setpoint","func":"mqtt_msg = {}\nmqtt_msg.topic = \"/node/down/3\";\nmqtt_msg.payload = \"s \" + msg.payload;\nreturn mqtt_msg;","outputs":1,"noerr":0,"x":770,"y":540,"wires":[["5af7751.1321b8c","c0aef57a.263c58"]]},{"id":"c0aef57a.263c58","type":"mqtt out","z":"983d8884.0e0c58","name":"","topic":"","qos":"","retain":"","broker":"4a731906.628d48","x":990,"y":580,"wires":[]},{"id":"a1129f35.5a35c","type":"comment","z":"8e3dae77.2b0e1","name":"","info":"","x":860,"y":60,"wires":[]},{"id":"28df6077.08d84","type":"inject","z":"8e3dae77.2b0e1","name":"Both closed","topic":"","payload":"{\"house\":1,\"street\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":290,"y":1180,"wires":[[]]},{"id":"f1f06dce.1fdf3","type":"inject","z":"8e3dae77.2b0e1","name":"House opening","topic":"","payload":"{\"house\":3,\"street\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":300,"y":940,"wires":[[]]},{"id":"f1039450.68e6e8","type":"inject","z":"8e3dae77.2b0e1","name":"House open","topic":"","payload":"{\"house\":2,\"street\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":290,"y":980,"wires":[[]]},{"id":"9e5d6f3d.bed05","type":"inject","z":"8e3dae77.2b0e1","name":"House Closing","topic":"","payload":"{\"house\":4,\"street\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":300,"y":1020,"wires":[[]]},{"id":"82423bda.b7ac38","type":"inject","z":"8e3dae77.2b0e1","name":"Street opening","topic":"","payload":"{\"house\":1,\"street\":3}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":300,"y":1060,"wires":[[]]},{"id":"2207ce7d.0f2192","type":"inject","z":"8e3dae77.2b0e1","name":"Street open","topic":"","payload":"{\"house\":1,\"street\":2}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":290,"y":1100,"wires":[[]]},{"id":"cf071cde.b66b8","type":"inject","z":"8e3dae77.2b0e1","name":"Street Closing","topic":"","payload":"{\"house\":1,\"street\":4}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":290,"y":1140,"wires":[[]]},{"id":"c3af9d7a.46b7f","type":"function","z":"8e3dae77.2b0e1","name":"Node 0: Street","func":"GateState = msg.payload.voltages[1]\nmsg.payload.street = GateState\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":120,"wires":[["f502d627.6cfbd8","3f256fb0.6ad7"]]},{"id":"78c222f5.41099c","type":"function","z":"8e3dae77.2b0e1","name":"Node 4: House","func":"GateState = msg.payload.voltages[0]\nmsg.payload.house = GateState\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":180,"wires":[["f502d627.6cfbd8"]]},{"id":"cfdef8a3.db9f48","type":"function","z":"8e3dae77.2b0e1","name":"Node 5: Garage Doors","func":"upTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature / 1000;\nleft = msg.payload.voltages[0];\nright = msg.payload.voltages[1];\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction doorStateToString (state){\n    switch(state)\n    {\n        default:\n            return \"Unknown\";\n        case 1:\n            return \"Closed\";\n        case 2:\n            return \"Moving\";\n        case 3:\n            return \"Open\";\n    }\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Garage Doors*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\" +\n              \"\\nLeft: \" + doorStateToString(left) +\n              \"\\nRight: \" + doorStateToString(right)\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":380,"wires":[["9f764455.ac1488"]]},{"id":"694804a8.d21ffc","type":"function","z":"8e3dae77.2b0e1","name":"Node 6: Water","func":"is_sample = msg.payload.voltages[2];\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature / 1000;\nvalve = msg.payload.voltages[0];\ntimeLeft = msg.payload.voltages[1] / 60;\ntimeLeft = timeLeft.toFixed(2)\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction waterStateToString (state){\n    switch(state)\n    {\n        default:\n            return \"Unknown\";\n        case 1:\n            return \"Open\";\n        case 2:\n            return \"Closed\";\n    }\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Water*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\" +\n              \"\\nValve: \" + waterStateToString(valve)\n              \nif(timeLeft > 0) {\n    msg.payload += \"\\nTimeLeft: \" + timeLeft + \" min\"\n}\n\n\nreturn msg","outputs":1,"noerr":0,"x":880,"y":420,"wires":[["9f764455.ac1488"]]},{"id":"a89ace63.1be2","type":"function","z":"983d8884.0e0c58","name":"Water Msg","func":"args = msg.payload.content.split(\" \")\n\nif(args.length <= 1)\n    return [null, null];\n\nif(args[0] != \"W\")\n    return [null, null];\n    \nif((args[1] == \"open\")) {\n    \n    msg.payload.content = \"Opening water\";\n    \n    setMsg = {};\n    setMsg.payload = 1;\n    \n    return [msg, setMsg];\n}\n\nif((args[1] == \"close\")) {\n    \n    msg.payload.content = \"Closing water\";\n    \n    setMsg = {};\n    setMsg.payload = 0;\n    \n    return [msg, setMsg];\n}\n\nreturn [null, null];","outputs":2,"noerr":0,"x":490,"y":600,"wires":[["a9c689a6.2c53f8"],["50bd6454.6144cc"]]},{"id":"50bd6454.6144cc","type":"function","z":"983d8884.0e0c58","name":"Set node 6 valve","func":"mqtt_msg = {}\nmqtt_msg.topic = \"/node/down/6\";\nmqtt_msg.payload = \"w \" + msg.payload;\nreturn mqtt_msg;","outputs":1,"noerr":0,"x":750,"y":600,"wires":[["c0aef57a.263c58"]]},{"id":"fdb44816.3f8228","type":"inject","z":"983d8884.0e0c58","name":"Water every morning","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"00 03 * * *","once":false,"onceDelay":0.1,"x":460,"y":640,"wires":[[]]},{"id":"8e6ceac5.52f468","type":"mqtt in","z":"8e3dae77.2b0e1","name":"","topic":"/up/esp/+","qos":"1","broker":"4a731906.628d48","x":120,"y":780,"wires":[["32f41da4.4d9e62","b3a36b41.6bfd88"]]},{"id":"b3a36b41.6bfd88","type":"function","z":"8e3dae77.2b0e1","name":"Make Sonoff","func":"mac = msg.topic.split('/')[3]\ndata = JSON.parse(msg.payload)\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nif(data.msg !== undefined)\n{\n    //TelegramMessage\n    msg.payload = \"*Sonoff* \" + mac + \"\\n\"\n    msg.payload += data.msg\n    \n    return [null, null, msg]\n}\n\ninflux = {}\ninflux.payload = [\n    {\"T\":data.temp,\n    \"V0\":data.voltages[0],\n    \"V1\":data.voltages[1],\n    \"V2\":data.voltages[2],\n    \"V3\":data.voltages[3]\n    },\n    {\"id\":mac\n    }\n]\n\nreturn [null, influx];","outputs":2,"noerr":0,"x":370,"y":820,"wires":[["5c8621a5.40ca7"],["adf01779.fa5ea8"]]},{"id":"5c8621a5.40ca7","type":"subflow:acf214e0.5d8368","z":"8e3dae77.2b0e1","name":"","x":590,"y":800,"wires":[]},{"id":"32f41da4.4d9e62","type":"debug","z":"8e3dae77.2b0e1","name":"ESP String","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":370,"y":760,"wires":[]},{"id":"e43ea429.7fde78","type":"subflow:acf214e0.5d8368","z":"8e3dae77.2b0e1","name":"","x":1750,"y":140,"wires":[]},{"id":"eb734026.08031","type":"function","z":"8e3dae77.2b0e1","name":"Fill Gate message","func":"upTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature / 1000;\n\nif(msg.payload.node === \"0\")\n{\n    temp -= 15;\n}\nif(msg.payload.node === \"1\")\n{\n    temp -= 12;\n}\n\n\nfunction gateStateToString (state){\n    switch(state)\n    {\n        default:\n            return \"Unknown\";\n        case 1:\n            return \"Closed\";\n        case 2:\n            return \"Open\";\n        case 3:\n            return \"Opening\";\n        case 4:\n            return \"Closing\";\n        case 5:\n            return \"Courtesy ON\";\n        case 6:\n            return \"Power Failure\";\n        case 7:\n            return \"Battery low\";\n        case 8:\n            return \"Obstruction\";\n            \n    }\n}\n\nhouseGate  = flow.get(\"houseGate\") || 1;\nstreetGate = flow.get(\"streetGate\") || 1;\n\nstreetGate = gateStateToString(streetGate);\nhouseGate = gateStateToString(houseGate);\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Gates*\" + \n                        \"\\nStreet: \" + streetGate +\n                        \"\\nHouse: \" + houseGate +\n                        \"\\nUp time: \" + upTime + \n                        \"\\ntemp: \" + temp.toFixed(2)\nreturn msg;","outputs":1,"noerr":0,"x":1510,"y":100,"wires":[["e43ea429.7fde78"]]},{"id":"dc11a06.0c3206","type":"delay","z":"8e3dae77.2b0e1","name":"","pauseType":"delay","timeout":"180","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1490,"y":160,"wires":[["e43ea429.7fde78"]]},{"id":"f502d627.6cfbd8","type":"function","z":"8e3dae77.2b0e1","name":"Gate access","func":"if(msg.payload.hasOwnProperty('house'))\n{\n    flow.set(\"houseGate\", msg.payload.house);\n}\n\nif(msg.payload.hasOwnProperty('street'))\n{\n    flow.set(\"streetGate\", msg.payload.street);\n}\n\nhouseGate  = flow.get(\"houseGate\") || 1;\n\nstreetGate = flow.get(\"streetGate\") || 1;\n\nfunction gateStateToString (state){\n    switch(state)\n    {\n        default:\n            return \"Unknown\";\n        case 1:\n            return \"Closed\";\n        case 2:\n            return \"Open\";\n        case 3:\n            return \"Opening\";\n        case 4:\n            return \"Closing\";\n        case 5:\n            return \"Courtesy ON\";\n        case 6:\n            return \"Power Failure\";\n        case 7:\n            return \"Battery low\";\n        case 8:\n            return \"Obstruction\";\n            \n    }\n}\n\nsend_node = null\nsend_message = null\nsend_delay = null\n\nfunction gateMoved(state)\n{\n    switch(state)\n    {\n        default: //Unknown\n        case 1: //Closed\"\n        case 5: //Courtesy ON\n        case 6: //Power Failure\n        case 7: //Battery low\n        case 8: //Obstruction\n            return false;\n        case 2: //Open\n       // case 3: //Opening\n        case 4: //Closing\n            return true;\n    }\n}\n\nif(gateMoved(houseGate))\n    flow.set(\"houseAccess\", true)\n\n//when only house gate opened and closed\nif((houseGate === 1) &&\n    (flow.get(\"houseAccess\") === true) &&\n    (flow.get(\"streetAccess\") === false))\n{\n    send_message = {}\n    send_message.payload = \"House gate accessed\";\n    flow.set(\"houseAccess\", false)\n}\n\nif(houseGate === 2)\n{\n    send_delay = {}\n    send_delay.payload = \"House gate left open\";\n}\n\n\n//when the gates started to move set access flag\nif(gateMoved(streetGate))\n    flow.set(\"streetAccess\", true)\n    \n//when only street gate opened and closed\nif((streetGate === 1) && \n    (flow.get(\"streetAccess\") === true) &&\n    (flow.get(\"houseAccess\") === false))\n{\n    send_message = {}\n    send_message.payload = \"Street gate accessed\";\n    flow.set(\"streetAccess\", false)\n}\n\n//prepare delayed message to send when gates are left open\nif(streetGate === 2)\n{\n    send_delay = {}\n    send_delay.payload = \"Street gate left open\";\n}\n \n//when both gates closed after access\nif((houseGate === 1) &&\n    (streetGate === 1) &&\n    (flow.get(\"streetAccess\") === true) &&\n    (flow.get(\"houseAccess\") === true))\n{\n    send_message = {}\n    send_message.payload = \"Gates accessed\";\n    flow.set(\"streetAccess\", false)\n    flow.set(\"houseAccess\", false)\n}\n\n//reset delay when both gates closed\nif((streetGate === 1) && (houseGate === 1))\n{\n    send_delay = {}\n    send_delay.reset = 1;\n}\n\nif(global.get(\"requested\") === true)\n{\n   send_node = JSON.parse(JSON.stringify(msg));\n}\n\nglobal.set(\"requested\", false)\n\nreturn [send_node, send_message, send_delay] ;","outputs":3,"noerr":0,"x":1190,"y":140,"wires":[["eb734026.08031"],["e43ea429.7fde78"],["dc11a06.0c3206"]]},{"id":"3f256fb0.6ad7","type":"debug","z":"8e3dae77.2b0e1","name":"send_msg","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1190,"y":80,"wires":[]},{"id":"2af14334.72fadc","type":"function","z":"983d8884.0e0c58","name":"TV Room Msg","func":"args = msg.payload.content.split(\" \")\n\nif(args.length <= 1)\n    return [null, null];\n\nif(args[0] != \"T\")\n    return [null, null];\n    \nif((args[1] == \"toggle\")) {\n    \n    msg.payload.content = \"Toggling Light switch\";\n    \n    setMsg = {};\n    setMsg.payload = 1;\n    \n    return [msg, setMsg];\n}\n\nif((args[1] == \"normal\")) {\n    \n    msg.payload.content = \"TV normal\";\n    \n    setMsg = {};\n    setMsg.payload = 0;\n    \n    return [msg, setMsg];\n}\n\nif((args[1] == \"tv\")) {\n    \n    msg.payload.content = \"Watching TV\";\n    \n    setMsg = {};\n    setMsg.payload = 2;\n    \n    return [msg, setMsg];\n}\n\n\nif((args[1] == \"run\")) {\n    \n    msg.payload.content = \"Running\";\n    \n    setMsg = {};\n    setMsg.payload = 4;\n    \n    return [msg, setMsg];\n}\n\nreturn [null, null];","outputs":2,"noerr":0,"x":500,"y":720,"wires":[["a9c689a6.2c53f8"],["a62800b9.0a349"]]},{"id":"a62800b9.0a349","type":"function","z":"983d8884.0e0c58","name":"Set node 4 lights","func":"mqtt_msg = {}\nmqtt_msg.topic = \"/node/down/2\";\nmqtt_msg.payload = \"l \" + msg.payload;\nreturn mqtt_msg;","outputs":1,"noerr":0,"x":750,"y":720,"wires":[["c0aef57a.263c58"]]},{"id":"9b4b86a0.d331c8","type":"function","z":"8e3dae77.2b0e1","name":"Node 7: Clock","func":"is_sample = msg.payload.voltages[2];\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature / 1000;\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Clock*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n   \nreturn msg","outputs":1,"noerr":0,"x":880,"y":460,"wires":[["9f764455.ac1488"]]},{"id":"89514d16.e5e29","type":"influxdb out","z":"8e3dae77.2b0e1","influxdb":"9818fae6.808138","name":"","measurement":"nodes","precision":"","retentionPolicy":"","x":550,"y":500,"wires":[]},{"id":"adf01779.fa5ea8","type":"influxdb out","z":"8e3dae77.2b0e1","influxdb":"9818fae6.808138","name":"","measurement":"nodes","precision":"","retentionPolicy":"","x":670,"y":840,"wires":[]},{"id":"c75ceba6.731908","type":"influxdb in","z":"8d9e59c5.1bb608","influxdb":"9818fae6.808138","name":"Query UPS","query":"SELECT * from nodes ORDER BY time ASC limit 3000","rawOutput":false,"precision":"","retentionPolicy":"","x":730,"y":460,"wires":[["216f7435.a58a5c","452b20bf.0c77f","df29ab4f.6ec4c8","a13c182c.bb9e28"]]},{"id":"fced4870.bb6b28","type":"ui_ui_control","z":"8d9e59c5.1bb608","name":"","events":"all","x":260,"y":420,"wires":[["f4606d2c.71cb9"]]},{"id":"f4606d2c.71cb9","type":"function","z":"8d9e59c5.1bb608","name":"was change","func":"if(msg.payload !== \"change\")\n    msg = null\n    \nreturn msg;","outputs":1,"noerr":0,"x":490,"y":420,"wires":[["c75ceba6.731908"]]},{"id":"216f7435.a58a5c","type":"function","z":"8d9e59c5.1bb608","name":"Draw Temperatures","func":"items = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [ \"Gate\", \"UPS\", \"Garage\", \"Water\", \"Clock\", \"Geyser\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\ngraph.payload[0].data[3] = []\ngraph.payload[0].data[4] = []\ngraph.payload[0].data[5] = []\n\nfor (var i = 0; i < items.length; i++) {\n    series = -1\n    if(items[i].id === \"0\")\n        series = 0\n    if(items[i].id === \"1\")\n        series = 1\n    if(items[i].id === \"5\") {\n        series = 2\n        continue //Discard Garage temperature\n    }\n    if(items[i].id === \"6\")\n        series = 3\n    if(items[i].id === \"7\")\n        series = 4\n    if(items[i].id === \"dc:4f:22:98:04:df\")\n        series = 5\n \n    \n    if(series >= 0) {\n        graph.payload[0].data[series].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].T } )\n    }\n}\n\n\n\nreturn graph","outputs":1,"noerr":0,"x":970,"y":360,"wires":[["5414fc4e.0d6ed4"]]},{"id":"452b20bf.0c77f","type":"function","z":"8d9e59c5.1bb608","name":"Draw UPS","func":"items = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [\"12V\", \"12A\", \"230V\", \"230A\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\ngraph.payload[0].data[3] = []\n\nfor (var i = 0; i < items.length; i++) {\n    series = -1\n    if(items[i].id === \"1\")\n        series = 0\n    \n    if(series >= 0) {\n        graph.payload[0].data[0].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V0 / 1000 } )\n        graph.payload[0].data[1].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].V1 - 32768) / 1000 } )\n        graph.payload[0].data[2].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V2 / 1000 } )\n        graph.payload[0].data[3].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].V3 - 32768) / 1000 } )\n    }\n}\n\nreturn graph","outputs":1,"noerr":0,"x":950,"y":420,"wires":[["c9018619.9d25b8"]]},{"id":"c9018619.9d25b8","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":3,"width":"6","height":"6","label":"UPS","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"step","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1170,"y":420,"wires":[[]]},{"id":"5414fc4e.0d6ed4","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":1,"width":"6","height":"6","label":"Temperature","chartType":"line","legend":"true","xformat":"dd HH:mm","interpolate":"step","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#008000","#aec7e8","#ff7f0e","#0080ff","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1190,"y":300,"wires":[[]]},{"id":"89c5402d.96a3b","type":"function","z":"8e3dae77.2b0e1","name":"Make Fermenter message","func":"//Do not send anything, just log\n\nif(global.get(\"requestedFermenter\") === false)\n{\n    global.set(\"requestedFermenter\", false)\n   return null;\n}\nglobal.set(\"requestedFermenter\", false)\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature / 1000;\nonboard = msg.payload.voltages[0] / 1000;\ntemp0 = msg.payload.voltages[1] / 1000;\ntemp1 = msg.payload.voltages[2] / 1000;\nsetpoint = msg.payload.voltages[3] / 1000;\n\ncooler = \"OFF\";\nif(msg.payload.outputs === 1)\n    cooler = \"ON\"\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Fermenter*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nCooler: \" + cooler + \n              \"\\nCPU: \" + temp.toFixed(2) + \" C\" +\n              //\"\\nonboard: \" + onboard.toFixed(2) + \" C\" +\n              \"\\nsetpoint: \" + setpoint.toFixed(2) + \" C\" +\n              \"\\ntemp0: \" + temp0.toFixed(2) + \" C\" +\n              \"\\ntemp1: \" + temp1.toFixed(2) + \" C\"\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":340,"wires":[["9f764455.ac1488"]]},{"id":"80f1ef55.09a96","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"b88984f.d6a7478","order":1,"width":6,"height":6,"label":"Chamber","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"The fermenter has not ever sent me stuff","dot":false,"ymin":"","ymax":"","removeOlder":"12","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1180,"y":480,"wires":[[]]},{"id":"df29ab4f.6ec4c8","type":"function","z":"8d9e59c5.1bb608","name":"Draw Fermenter","func":"items = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [\"CPU\", \"Onboard\", \"T0\", \"T1\", \"Setpoint\", \"Cooler\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\ngraph.payload[0].data[3] = []\ngraph.payload[0].data[4] = []\ngraph.payload[0].data[5] = []\n\nfor (var i = 0; i < items.length; i++) {\n    series = -1\n    if(items[i].id === \"3\")\n        series = 0\n    \n    if(series >= 0) {\n        graph.payload[0].data[0].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].T / 1000 } )\n        graph.payload[0].data[1].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V0 / 1000 } )\n        graph.payload[0].data[2].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V1 / 1000 } )\n        graph.payload[0].data[3].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V2 / 1000 } )\n        graph.payload[0].data[4].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V3 / 1000 } )\n        \n        cooler = items[i].T\n        if(msg.payload.outputs === 1)\n            cooler = (items[i].V3 / 1000 - 5)\n    }\n}\n\nreturn graph","outputs":1,"noerr":0,"x":960,"y":480,"wires":[["80f1ef55.09a96"]]},{"id":"a13c182c.bb9e28","type":"function","z":"8d9e59c5.1bb608","name":"State to values","func":"function gateStateToNumber (state){\n    switch(state)\n    {\n        case 1:\n            return 0;\n        case 2:\n            return 1;\n        case 3:\n        case 4:\n            return 0.5;\n        case 5:\n        case 6:\n        case 7:\n        case 8:\n            return -1;\n        default:\n            return -1;\n            \n    }\n}\n\nfunction doorStateToNumber (state){\n    switch(state)\n    {\n        default:\n        case 1: //Closed\n            return 0;\n        case 2: //moving\n            return 0.5;\n        case 3: //Open\n            return 1;\n    }\n}\n\nitems = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [\"Street\", \"House\", \"Left\", \"Right\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\ngraph.payload[0].data[3] = []\n\nfor (var i = 0; i < items.length; i++) {\n    series = -1\n    if(items[i].id === \"0\")\n        series = 0\n    if(items[i].id === \"4\")\n        series = 1\n    if(items[i].id === \"5\") {\n        graph.payload[0].data[2].push( { \"x\": Date.parse(items[i].time), \"y\": doorStateToNumber(items[i].V0) } )\n        graph.payload[0].data[3].push( { \"x\": Date.parse(items[i].time), \"y\": doorStateToNumber(items[i].V1) } )\n        continue\n    }\n    \n    if(series >= 0) {\n        graph.payload[0].data[series].push( { \"x\": Date.parse(items[i].time), \"y\": gateStateToNumber(items[i].V0) } )\n    }\n}\n\nreturn graph","outputs":1,"noerr":0,"x":960,"y":540,"wires":[["c2dddfd0.6a82a"]]},{"id":"c2dddfd0.6a82a","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":4,"width":"6","height":"6","label":"GateStates","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"step","nodata":"","dot":true,"ymin":"0","ymax":"1.5","removeOlder":"8","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1190,"y":540,"wires":[[]]},{"id":"7a4c91ca.b7e58","type":"ui_button","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":2,"width":0,"height":0,"passthru":false,"label":"Show Today","tooltip":"Plots only todays values","color":"","bgcolor":"","icon":"","payload":"","payloadType":"date","topic":"","x":250,"y":480,"wires":[["a9514614.0327f8"]]},{"id":"a9514614.0327f8","type":"function","z":"8d9e59c5.1bb608","name":"Query todays values","func":"msg.query = \"SELECT * from nodes where time > now() - 1d  ORDER BY time DESC limit 1000\"\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":480,"wires":[["c75ceba6.731908"]]},{"id":"29867bc1.7b5394","type":"function","z":"8d9e59c5.1bb608","name":"Query last 12H values","func":"msg.query = \"SELECT * from nodes where time > now() - 12h  ORDER BY time DESC limit 1000\"\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":520,"wires":[["c75ceba6.731908"]]},{"id":"7a59bb84.6c9f34","type":"ui_button","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":2,"width":0,"height":0,"passthru":false,"label":"Show last 12 hours","tooltip":"Plots only todays values","color":"","bgcolor":"","icon":"","payload":"","payloadType":"date","topic":"","x":230,"y":520,"wires":[["29867bc1.7b5394"]]},{"id":"ecc8ef02.575c5","type":"function","z":"8d9e59c5.1bb608","name":"Query last 30m values","func":"msg.query = \"SELECT * from nodes where time > now() - 30m  ORDER BY time DESC limit 1000\"\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":560,"wires":[["c75ceba6.731908"]]},{"id":"cc57ed0b.ee94c","type":"ui_button","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":2,"width":0,"height":0,"passthru":false,"label":"Show last half hour","tooltip":"Plots only todays values","color":"","bgcolor":"","icon":"","payload":"","payloadType":"date","topic":"","x":230,"y":560,"wires":[["ecc8ef02.575c5"]]}]