[{"id":"8e3dae77.2b0e1","type":"tab","label":"NodeMQTT","disabled":false,"info":""},{"id":"983d8884.0e0c58","type":"tab","label":"Telegram","disabled":false,"info":""},{"id":"8d9e59c5.1bb608","type":"tab","label":"Graphs","disabled":false,"info":""},{"id":"8bca10f1.5dd4c","type":"tab","label":"Influx","disabled":false,"info":""},{"id":"32ef613c.4a13ee","type":"tab","label":"GoogleHome","disabled":false,"info":""},{"id":"acf214e0.5d8368","type":"subflow","name":"TX Telegram","info":"","category":"","in":[{"x":540,"y":160,"wires":[{"id":"de6aedb9.d1f99"}]}],"out":[]},{"id":"c0d7e3a7.9516f","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Erasmus Home","hideToolbar":"false","allowSwipe":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":60,"sy":60,"gx":6,"gy":6,"cx":6,"cy":6,"px":6,"py":6},"lockMenu":"false"}},{"id":"4a731906.628d48","type":"mqtt-broker","z":"","name":"","broker":"localhost","port":"1883","clientid":"JanusVPS","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"a7800071.8aa72","type":"ui_group","z":"","name":"Home","tab":"1c979d26.9d96c3","order":2,"disp":false,"width":8,"collapse":false},{"id":"1c979d26.9d96c3","type":"ui_tab","z":"","name":"Erasmus Home","icon":"home","order":1,"disabled":false,"hidden":false},{"id":"2f4e5a55.3805d6","type":"telegram bot","z":"","botname":"janus_vps_bot","usernames":"janus_erasmus","chatids":"","baseapiurl":"","pollinterval":"300","usesocks":false,"sockshost":"","socksport":"","socksusername":"","sockspassword":"","bothost":"","localbotport":"","publicbotport":"","privatekey":"","certificate":"","useselfsignedcertificate":false,"verboselogging":false},{"id":"9818fae6.808138","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"_internal","name":"","usetls":false,"tls":""},{"id":"c0798c8e.d32c5","type":"ui_tab","z":"","name":"Fermenter","icon":"local_bar","order":3,"disabled":false,"hidden":false},{"id":"b88984f.d6a7478","type":"ui_group","z":"","name":"Temperature","tab":"c0798c8e.d32c5","order":1,"disp":false,"width":"6","collapse":false},{"id":"60339c65.a26d34","type":"ui_group","z":"","name":"Memory","tab":"96702ea5.2bde3","disp":true,"width":"6","collapse":false},{"id":"96702ea5.2bde3","type":"ui_tab","z":"","name":"Influx","icon":"dashboard","order":4,"disabled":false,"hidden":false},{"id":"66c477f.2ecc188","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"erasmus_home","name":"Erasmus","usetls":false,"tls":""},{"id":"b234ef0e.72a81","type":"ui_spacer","name":"spacer","group":"60339c65.a26d34","order":7,"width":6,"height":1},{"id":"82fb7029.91b39","type":"ui_spacer","name":"spacer","group":"60339c65.a26d34","order":9,"width":6,"height":1},{"id":"3ebeb9c.9a8b046","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":2,"width":1,"height":1},{"id":"988288c6.5abef8","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":6,"width":1,"height":1},{"id":"3436d75f.8bbc48","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":7,"width":1,"height":1},{"id":"1e723966.6def17","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":11,"width":1,"height":1},{"id":"74f172bd.f621cc","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":12,"width":1,"height":1},{"id":"ad248c1.979a37","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":16,"width":1,"height":1},{"id":"6902282e.d95858","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":17,"width":8,"height":1},{"id":"7c4b883f.bb66b8","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":19,"width":8,"height":1},{"id":"a4294563.1db648","type":"ui_spacer","name":"spacer","group":"a7800071.8aa72","order":21,"width":8,"height":1},{"id":"f966ca01.f24958","type":"google-home-conf","z":"","username":"JanusErasmus","localControl":false},{"id":"45387e24.08f0f","type":"ui_tab","z":"","name":"Overview","icon":"dashboard","order":2,"disabled":false,"hidden":false},{"id":"387c7f87.6a23f","type":"ui_group","z":"","name":"Temperatures","tab":"45387e24.08f0f","order":1,"disp":true,"width":4,"collapse":false},{"id":"f3ed241f.996fa8","type":"mqtt in","z":"8e3dae77.2b0e1","name":"","topic":"/node/up/+","qos":"2","datatype":"auto","broker":"4a731906.628d48","x":120,"y":320,"wires":[["a90c6a26.868bb8","deecbbf2.74ffb8"]]},{"id":"deecbbf2.74ffb8","type":"function","z":"8e3dae77.2b0e1","name":"parseString","func":"msg.payload = JSON.parse(msg.payload);\n\nif(msg.payload.uptime < 0){\n    msg.payload.uptime = (-1*msg.payload.uptime) + 2147483648\n}\n\nmsg.payload.node = msg.topic.split('/')[3]\n\nfunction get_signed_int(number){\n    if(number > 32768){\n        number ^= 0xFFFF;\n        number = -(number + 1);\n    }\n    \n    return number;\n}\n\nmsg.payload.temperature = get_signed_int(msg.payload.temperature) / 1000;\nmsg.payload.voltages[0] = get_signed_int(msg.payload.voltages[0]);\nmsg.payload.voltages[1] = get_signed_int(msg.payload.voltages[1]);\nmsg.payload.voltages[2] = get_signed_int(msg.payload.voltages[2]);\nmsg.payload.voltages[3] = get_signed_int(msg.payload.voltages[3]);\n\n// node.warn(\"T: \" + msg.payload.temperature)\n\ninflux = {}\ninflux.payload = [\n    {\n    \"uptime\":msg.payload.uptime,\n    \"T\":msg.payload.temperature,\n    \"V0\":msg.payload.voltages[0],\n    \"V1\":msg.payload.voltages[1],\n    \"V2\":msg.payload.voltages[2],\n    \"V3\":msg.payload.voltages[3],\n    \"In\":msg.payload.inputs,\n    \"Out\":msg.payload.inputs\n    },\n    {\"id\":msg.payload.node\n    }\n]\n\nreturn [msg, influx];","outputs":2,"noerr":0,"x":310,"y":340,"wires":[["cf1b1e9a.65ffb"],["89514d16.e5e29"]]},{"id":"c16166b6.8fc318","type":"mqtt out","z":"983d8884.0e0c58","name":"","topic":"","qos":"","retain":"","broker":"4a731906.628d48","x":990,"y":260,"wires":[]},{"id":"76a8db9a.e81884","type":"function","z":"983d8884.0e0c58","name":"Request all nodes to report","func":"msg = {}\nmsg.topic = \"/node/down/255\";\nmsg.payload = \"report\";\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":260,"wires":[["c16166b6.8fc318"]]},{"id":"f6bdab86.895d78","type":"telegram event","z":"983d8884.0e0c58","name":"Event","bot":"2f4e5a55.3805d6","event":"callback_query","autoanswer":"","x":130,"y":300,"wires":[["59c50f12.7dc56"]]},{"id":"a4e1d758.715558","type":"telegram sender","z":"983d8884.0e0c58","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":710,"y":200,"wires":[[]]},{"id":"59c50f12.7dc56","type":"switch","z":"983d8884.0e0c58","name":"Answer","property":"payload.content","propertyType":"msg","rules":[{"t":"eq","v":"OPT STATUS","vt":"str"},{"t":"eq","v":"OPT SET","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":300,"y":300,"wires":[["d489a649.1ce6b8"],["b290fc3c.fd972"]]},{"id":"d489a649.1ce6b8","type":"function","z":"983d8884.0e0c58","name":"Return status","func":"global.set(\"requested\", true)\nglobal.set(\"requestedFermenter\", true)\nmsg.payload.options = false\nmsg.payload.content = \"Requesting...\"\nreturn [msg, msg];","outputs":2,"noerr":0,"x":510,"y":260,"wires":[["a4e1d758.715558"],["76a8db9a.e81884"]]},{"id":"b290fc3c.fd972","type":"function","z":"983d8884.0e0c58","name":"Reply requests","func":"global.set(\"requested\", true)\nmsg.payload.options = false\nmsg.payload.content = \"Light switch on requested...\"\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":320,"wires":[["52c77317.75f77c","4a6101f9.b0eb2"]]},{"id":"52c77317.75f77c","type":"telegram sender","z":"983d8884.0e0c58","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":730,"y":360,"wires":[[]]},{"id":"94a32c13.ceb9","type":"function","z":"983d8884.0e0c58","name":"Build options","func":"global.set(\"chatId\", msg.payload.chatId)\n\nmsg.payload.type = \"message\"\nmsg.payload.options = {\n    reply_markup: JSON.stringify({\n        inline_keyboard: [\n            [{\n                \"text\":\"Query\",\n                \"callback_data\":\"OPT STATUS\"\n            },\n            {\n                \"text\":\"Lights\",\n                \"callback_data\":\"OPT SET\"\n            }\n            ]\n        ]\n    }),\n    parse_mode : \"Markdown\"\n}\n\nmsg.payload.content = \"**Please select:**\"\n\nreturn msg","outputs":1,"noerr":0,"x":450,"y":80,"wires":[["41d7576d.bf3568"]]},{"id":"ae7f4159.02549","type":"telegram command","z":"983d8884.0e0c58","name":"start","command":"/start","bot":"2f4e5a55.3805d6","x":130,"y":80,"wires":[["94a32c13.ceb9"],[]]},{"id":"41d7576d.bf3568","type":"telegram sender","z":"983d8884.0e0c58","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":710,"y":80,"wires":[[]]},{"id":"cf1b1e9a.65ffb","type":"switch","z":"8e3dae77.2b0e1","name":"Nodes","property":"payload.node","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"},{"t":"eq","v":"4","vt":"str"},{"t":"eq","v":"5","vt":"str"},{"t":"eq","v":"6","vt":"str"},{"t":"eq","v":"7","vt":"str"},{"t":"eq","v":"8","vt":"str"},{"t":"eq","v":"9","vt":"str"},{"t":"eq","v":"10","vt":"str"},{"t":"eq","v":"11","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":13,"x":490,"y":340,"wires":[["72613977.e7f4c8"],["67d944e6.9e618c"],["89bf197a.c847f8"],["89c5402d.96a3b"],["72613977.e7f4c8"],["cfdef8a3.db9f48"],["694804a8.d21ffc"],["9b4b86a0.d331c8"],["c5e0cb36.3d3788"],["db688881.294008"],["4d2ff602.352828"],["6dc68748.d26558"],["37913740.4d89c8"]]},{"id":"67d944e6.9e618c","type":"function","z":"8e3dae77.2b0e1","name":"Node 1: UPS","func":"is_sample = ((msg.payload.inputs & 0x02) === 0x02)\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\nvoltage = msg.payload.voltages[0] / 1000;\ncurrent = (msg.payload.voltages[1] - 32768) / 1000;\nvoltage_230 = msg.payload.voltages[2] / 1000;\ncurrent_230 = (msg.payload.voltages[3] - 32768) / 1000;\n\n\nmains = \"Failure\";\nif((msg.payload.inputs & 0x01) === 0x01)\n    mains = \"OK\";\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*UPS*\" +\n              \"\\nUp time     : \" + upTime + \n              \"\\nTemperature : \" + temp.toFixed(2) + \" C\" +\n              \"\\nMains       : \" + mains +\n              \"\\n12V Voltage : \" + voltage.toFixed(2) + \" V\" +\n              \"\\n12V Current : \" + current.toFixed(3) + \" A\" +\n              \"\\n230V Voltage: \" + voltage_230.toFixed(2) + \" V\" +\n              \"\\n230V Current: \" + current_230.toFixed(3) + \" A\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":220,"wires":[["9f764455.ac1488"]]},{"id":"37913740.4d89c8","type":"function","z":"8e3dae77.2b0e1","name":"Make default message","func":"upTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Node:*\" + msg.payload.node +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":660,"wires":[["9f764455.ac1488"]]},{"id":"736a10fe.6407","type":"mqtt in","z":"8e3dae77.2b0e1","name":"","topic":"/pi","qos":"0","datatype":"auto","broker":"4a731906.628d48","x":130,"y":720,"wires":[["1ec8e3ef.7eebfc","edfb7fdf.83d28"]]},{"id":"1ec8e3ef.7eebfc","type":"debug","z":"8e3dae77.2b0e1","name":"Pi status","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":380,"y":700,"wires":[]},{"id":"edfb7fdf.83d28","type":"function","z":"8e3dae77.2b0e1","name":"Prepare message","func":"content = \"Raspberry pi is:\" + msg.payload\n\nmsg.payload = {}\nmsg.payload.chatId =  global.get(\"chatId\");\nmsg.payload.type = \"message\"\nmsg.payload.options = {\"parse_mode\":\"Markdown\"}\nmsg.payload.content = content\n\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":740,"wires":[["f8d5fa85.f52ab8"]]},{"id":"f8d5fa85.f52ab8","type":"telegram sender","z":"8e3dae77.2b0e1","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":670,"y":740,"wires":[[]]},{"id":"b92887c0.dc0648","type":"telegram sender","z":"acf214e0.5d8368","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":970,"y":160,"wires":[[]]},{"id":"de6aedb9.d1f99","type":"function","z":"acf214e0.5d8368","name":"Prepare message","func":"content = msg.payload\n\nmsg.payload = {}\nmsg.payload.chatId =  global.get(\"chatId\");\nmsg.payload.type = \"message\"\nmsg.payload.options = {\"parse_mode\":\"Markdown\"}\nmsg.payload.content = content\n\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":160,"wires":[["b92887c0.dc0648"]]},{"id":"9f764455.ac1488","type":"subflow:acf214e0.5d8368","z":"8e3dae77.2b0e1","name":"","x":1210,"y":380,"wires":[]},{"id":"186cb390.1f3e4c","type":"mqtt out","z":"983d8884.0e0c58","name":"","topic":"","qos":"","retain":"","broker":"4a731906.628d48","x":990,"y":320,"wires":[]},{"id":"4a6101f9.b0eb2","type":"function","z":"983d8884.0e0c58","name":"Set node 0 lights","func":"msg = {}\nmsg.topic = \"/node/down/0\";\nmsg.payload = \"light\";\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":320,"wires":[["186cb390.1f3e4c"]]},{"id":"a90c6a26.868bb8","type":"debug","z":"8e3dae77.2b0e1","name":"Node String","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":310,"y":300,"wires":[]},{"id":"89bf197a.c847f8","type":"function","z":"8e3dae77.2b0e1","name":"Node 2: TV Room","func":"upTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*TV Room*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":260,"wires":[[]]},{"id":"f1c314f.92ff3e8","type":"telegram receiver","z":"983d8884.0e0c58","name":"RX message","bot":"2f4e5a55.3805d6","saveDataDir":"","x":150,"y":500,"wires":[["8fff48b4.4c0f78","a89ace63.1be2","2af14334.72fadc"],[]]},{"id":"a9c689a6.2c53f8","type":"telegram sender","z":"983d8884.0e0c58","name":"JanusVPS","bot":"2f4e5a55.3805d6","x":710,"y":480,"wires":[[]]},{"id":"8fff48b4.4c0f78","type":"function","z":"983d8884.0e0c58","name":"Fermenter Msg","func":"args = msg.payload.content.split(\" \")\n\nif(args.length <= 1)\n    return [null, null];\n\nif(args[0] != \"F\")\n    return [null, null];\n    \nif(isNaN(args[1]))\n    return [null, null];\n    \nmsg.payload.content = \"Setting fermenter setpoint to: \" + args[1]\n\nsetMsg = {};\nsetMsg.payload = args[1];\n\nreturn [msg, setMsg];","outputs":2,"noerr":0,"x":500,"y":500,"wires":[["a9c689a6.2c53f8"],["73151c2f.2d2cd4"]]},{"id":"5af7751.1321b8c","type":"debug","z":"983d8884.0e0c58","name":"Set fermenter","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1020,"y":540,"wires":[]},{"id":"73151c2f.2d2cd4","type":"function","z":"983d8884.0e0c58","name":"Set node 3 setpoint","func":"mqtt_msg = {}\nmqtt_msg.topic = \"/node/down/3\";\nmqtt_msg.payload = \"s \" + msg.payload;\nreturn mqtt_msg;","outputs":1,"noerr":0,"x":770,"y":540,"wires":[["5af7751.1321b8c","c0aef57a.263c58"]]},{"id":"c0aef57a.263c58","type":"mqtt out","z":"983d8884.0e0c58","name":"","topic":"","qos":"","retain":"","broker":"4a731906.628d48","x":990,"y":580,"wires":[]},{"id":"a1129f35.5a35c","type":"comment","z":"8e3dae77.2b0e1","name":"Node 0: Street","info":"","x":870,"y":180,"wires":[]},{"id":"cfdef8a3.db9f48","type":"function","z":"8e3dae77.2b0e1","name":"Node 5: Garage Doors","func":"is_sample = ((msg.payload.inputs & 0x02) === 0x02)\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\nleft = msg.payload.voltages[0];\nright = msg.payload.voltages[1];\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction doorStateToString (state){\n    switch(state)\n    {\n        default:\n            return \"Unknown\";\n        case 1:\n            return \"Closed\";\n        case 2:\n            return \"Moving\";\n        case 3:\n            return \"Open\";\n    }\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Garage Doors*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\" +\n              \"\\nLeft: \" + doorStateToString(left) +\n              \"\\nRight: \" + doorStateToString(right)\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":380,"wires":[["9f764455.ac1488"]]},{"id":"694804a8.d21ffc","type":"function","z":"8e3dae77.2b0e1","name":"Node 6: Water","func":"is_sample = msg.payload.voltages[2];\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\nvalve = msg.payload.voltages[0];\ntimeLeft = msg.payload.voltages[1] / 60;\ntimeLeft = timeLeft.toFixed(2)\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction waterStateToString (state){\n    switch(state)\n    {\n        default:\n            return \"Unknown\";\n        case 1:\n            return \"Open\";\n        case 2:\n            return \"Closed\";\n    }\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Water*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\" +\n              \"\\nValve: \" + waterStateToString(valve)\n              \nif(timeLeft > 0) {\n    msg.payload += \"\\nTimeLeft: \" + timeLeft + \" min\"\n}\n\n\nreturn msg","outputs":1,"noerr":0,"x":880,"y":420,"wires":[["9f764455.ac1488"]]},{"id":"a89ace63.1be2","type":"function","z":"983d8884.0e0c58","name":"Water Msg","func":"args = msg.payload.content.split(\" \")\n\nif(args.length <= 1)\n    return [null, null];\n\nif(args[0] != \"W\")\n    return [null, null];\n    \nif((args[1] == \"open\")) {\n    \n    msg.payload.content = \"Opening water\";\n    \n    setMsg = {};\n    setMsg.payload = 1;\n    \n    return [msg, setMsg];\n}\n\nif((args[1] == \"close\")) {\n    \n    msg.payload.content = \"Closing water\";\n    \n    setMsg = {};\n    setMsg.payload = 0;\n    \n    return [msg, setMsg];\n}\n\nreturn [null, null];","outputs":2,"noerr":0,"x":490,"y":600,"wires":[["a9c689a6.2c53f8"],["50bd6454.6144cc"]]},{"id":"50bd6454.6144cc","type":"function","z":"983d8884.0e0c58","name":"Set node 6 valve","func":"mqtt_msg = {}\nmqtt_msg.topic = \"/node/down/6\";\nmqtt_msg.payload = \"w \" + msg.payload;\nreturn mqtt_msg;","outputs":1,"noerr":0,"x":750,"y":600,"wires":[["c0aef57a.263c58"]]},{"id":"fdb44816.3f8228","type":"inject","z":"983d8884.0e0c58","name":"Water every morning","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"00 03 * * *","once":false,"onceDelay":0.1,"x":460,"y":640,"wires":[[]]},{"id":"8e6ceac5.52f468","type":"mqtt in","z":"8e3dae77.2b0e1","name":"","topic":"/up/esp/+","qos":"1","broker":"4a731906.628d48","x":120,"y":880,"wires":[["32f41da4.4d9e62","b3a36b41.6bfd88"]]},{"id":"b3a36b41.6bfd88","type":"function","z":"8e3dae77.2b0e1","name":"Make Sonoff","func":"mac = msg.topic.split('/')[3]\ndata = JSON.parse(msg.payload)\n\nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nif(data.msg !== undefined)\n{\n    //TelegramMessage\n    msg.payload = \"*Sonoff* \" + mac + \"\\n\"\n    msg.payload += data.msg\n    \n    return [null, null, msg]\n}\n\n//oofset Geyser[dc:4f:22:98:04:df] with 2 degrees\nif(mac == \"dc:4f:22:98:04:df\"){\n    data.temp += 2;    \n}\n\ninflux = {}\ninflux.payload = [\n    {\"T\":data.temp,\n    \"V0\":data.voltages[0],\n    \"V1\":data.voltages[1],\n    \"V2\":data.voltages[2],\n    \"V3\":data.voltages[3]\n    },\n    {\"id\":mac\n    }\n]\n\nreturn [null, influx];","outputs":2,"noerr":0,"x":370,"y":900,"wires":[["5c8621a5.40ca7"],["adf01779.fa5ea8"]]},{"id":"5c8621a5.40ca7","type":"subflow:acf214e0.5d8368","z":"8e3dae77.2b0e1","name":"","x":590,"y":900,"wires":[]},{"id":"32f41da4.4d9e62","type":"debug","z":"8e3dae77.2b0e1","name":"ESP String","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":370,"y":860,"wires":[]},{"id":"e43ea429.7fde78","type":"subflow:acf214e0.5d8368","z":"8e3dae77.2b0e1","name":"","x":1550,"y":120,"wires":[]},{"id":"dc11a06.0c3206","type":"delay","z":"8e3dae77.2b0e1","name":"","pauseType":"delay","timeout":"180","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1370,"y":140,"wires":[["e43ea429.7fde78"]]},{"id":"f502d627.6cfbd8","type":"function","z":"8e3dae77.2b0e1","name":"Gate access","func":"function gateStateToString(state) {\n    switch(state) {\n        default:\n            return \"Unknown\";\n        case 1:\n            return \"Closed\";\n        case 2:\n            return \"Open\";\n        case 3:\n            return \"Opening\";\n        case 4:\n            return \"Closing\";\n        case 5:\n            return \"Courtesy ON\";\n        case 6:\n            return \"Power Failure\";\n        case 7:\n            return \"Battery low\";\n        case 8:\n            return \"Obstruction\";\n            \n    }\n}\n\nfunction gateMoved(state)\n{\n    switch(state)\n    {\n        default: //Unknown\n        case 1: //Closed\"\n        case 5: //Courtesy ON\n        case 6: //Power Failure\n        case 7: //Battery low\n        case 8: //Obstruction\n            return false;\n        case 2: //Open\n       // case 3: //Opening\n        case 4: //Closing\n            return true;\n    }\n}\n\nfunction minutesToString(minFloat) {\n    now = minFloat * 60;\n\tif(now < 60) {\n\t\treturn Math.round(now) + \"s\";\n\t}\n\telse {\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60) {\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse {\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24) {\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nStreetUpTime = msg.street[0].uptime / 60000;\nHosueUpTime = msg.payload[0].uptime / 60000;\ntemp = msg.payload[0].T;\nstreetGate = msg.street[0].V1;\nhouseGate  = msg.payload[0].V0;\n\n//remember when gates moved\nif(gateMoved(streetGate)) {\n    flow.set(\"streetMoved\", true)\n}\nif(gateMoved(houseGate)) {\n    flow.set(\"houseMoved\", true)\n}\n\nif(streetGate === 2)\n{\n    send_delay = {}\n    send_delay.payload = \"House gate left open\";\n    node.send([null, send_delay])\n}\n\nif(houseGate === 2)\n{\n    send_delay = {}\n    send_delay.payload = \"Street gate left open\";\n    node.send([null, send_delay])\n}\n\nsend_delay = null\nmsg = null\nprev_street = flow.get(\"streetMoved\") || 0\nprev_house = flow.get(\"houseMoved\") || 0\n\nif(streetGate === 1) {\n    if(prev_street) {\n        msg = {}\n        msg.payload = \"Street gate Accessed\"\n        flow.set(\"streetMoved\", false)\n    }\n}\n\nif(houseGate === 1) {\n    if(prev_house) {\n        msg = {}\n        msg.payload = \"House gate Accessed\"\n        flow.set(\"houseMoved\", false)\n    }\n}\n\n//reset delay when both gates closed\nif((streetGate === 1) && (houseGate === 1))\n{\n    send_delay = {}\n    send_delay.reset = 1;\n    \n    if(prev_house && prev_street) {\n        msg = {}\n        msg.payload = \"Gates Accessed\"\n    }\n}\n\nnode.send([msg, send_delay])\n\nif(global.get(\"requested\") === false)\n{\n   return [null, null];\n}\nglobal.set(\"requested\", false)\n\nmsg = {}\nmsg.payload = \"*Gates*\" + \n                \"\\nStreet: \" + gateStateToString(streetGate) +\n                \"\\n Uptime: \" + minutesToString(HosueUpTime) + \n                \"\\nHouse: \" + gateStateToString(houseGate) +\n                \"\\n Uptime: \" + minutesToString(StreetUpTime) + \n                \"\\nT: \" + temp.toFixed(2)\nreturn [msg, null]\n","outputs":2,"noerr":0,"x":1190,"y":120,"wires":[["e43ea429.7fde78"],["dc11a06.0c3206"]]},{"id":"2af14334.72fadc","type":"function","z":"983d8884.0e0c58","name":"TV Room Msg","func":"args = msg.payload.content.split(\" \")\n\nif(args.length <= 1)\n    return [null, null];\n\nif(args[0] === \"L\")\n{\n    lampMsg = {}\n    if((args[1] == \"set\")) {\n        msg.payload.content = \"Set Lamp\";\n        lampMsg.payload = \"set\"\n        context.set('lamp_state', 'set')\n    }\n    if((args[1] == \"reset\")) {\n        msg.payload.content = \"Reset Lamp\";\n        lampMsg.payload = \"reset\"\n        context.set('lamp_state', 'reset')\n    }\n    \n    return [msg, null, lampMsg]\n}\n\n\nif(global.get('light_state') === undefined){\n    global.set('light_state', 'off')\n}\n\nif(context.get('lamp_state') === undefined){\n    context.set('lamp_state', 'reset')\n}\n\nif(args[0] != \"T\")\n    return [null, null];\n    \nif((args[1] == \"toggle\")) {\n    \n    msg.payload.content = \"Toggling Light switch\";\n    if(global.get('light_state') === 'off'){\n        global.set('light_state', 'on')\n    }\n    else {\n        global.set('light_state', 'off')\n    }\n    setMsg = {};\n    setMsg.payload = 1;\n    \n    //Make Lamps go off when light go off\n    lampMsg = null\n    if(context.get('light_state') === 'off'){\n        lampMsg = {}\n        lampMsg.payload = \"reset\"\n        context.set('lamp_state', 'reset')    \n    }\n    \n    return [msg, setMsg, lampMsg];\n}\n\nif((args[1] == \"normal\")) {\n    \n    msg.payload.content = \"TV normal\";\n    \n    setMsg = {};\n    setMsg.payload = 0;\n    lampMsg = null\n    \n    if(context.get('lamp_state') === 'set'){\n        lampMsg = {}\n        lampMsg.payload = \"reset\"\n        context.set('lamp_state', 'reset')\n    }\n    \n    return [msg, setMsg, lampMsg];\n}\n\nif((args[1] == \"tv\")) {\n    \n    if(global.get('light_state') === 'off'){\n        msg.payload.content = \"Toggling Light switch\";\n        setMsg = {};\n        setMsg.payload = 1;\n        global.set('light_state', 'on')\n        \n        node.send([msg, setMsg])\n    }\n    \n    msg.payload.content = \"Watching TV\";\n    \n    setMsg = {};\n    setMsg.payload = 2;\n    \n    context.set('lamp_state', 'set')\n    lampMsg = {}\n    lampMsg.payload = \"set\"\n    \n    return [msg, setMsg, lampMsg];\n}\n\n\nif((args[1] == \"run\")) {\n    \n    msg.payload.content = \"Running\";\n    \n    setMsg = {};\n    setMsg.payload = 4;\n    \n    return [msg, setMsg];\n}\n\nreturn [null, null];","outputs":3,"noerr":0,"x":500,"y":720,"wires":[["a9c689a6.2c53f8"],["a62800b9.0a349"],["ab5bbee.4dbbd4"]]},{"id":"a62800b9.0a349","type":"function","z":"983d8884.0e0c58","name":"Set node 2 lights","func":"mqtt_msg = {}\nmqtt_msg.topic = \"/node/down/2\";\nmqtt_msg.payload = \"l \" + msg.payload;\nreturn mqtt_msg;","outputs":1,"noerr":0,"x":750,"y":720,"wires":[["c0aef57a.263c58","64da20.e71665e"]]},{"id":"9b4b86a0.d331c8","type":"function","z":"8e3dae77.2b0e1","name":"Node 7: Clock","func":"is_sample = msg.payload.voltages[2];\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Clock*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n   \nreturn msg","outputs":1,"noerr":0,"x":880,"y":460,"wires":[["9f764455.ac1488"]]},{"id":"89514d16.e5e29","type":"influxdb out","z":"8e3dae77.2b0e1","influxdb":"66c477f.2ecc188","name":"Nodes","measurement":"nodes","precision":"","retentionPolicy":"","x":490,"y":520,"wires":[]},{"id":"adf01779.fa5ea8","type":"influxdb out","z":"8e3dae77.2b0e1","influxdb":"66c477f.2ecc188","name":"Nodes","measurement":"nodes","precision":"","retentionPolicy":"","x":570,"y":940,"wires":[]},{"id":"c75ceba6.731908","type":"influxdb in","z":"8d9e59c5.1bb608","influxdb":"66c477f.2ecc188","name":"Query Nodes","query":"SELECT * from nodes ORDER BY time DESC limit 3000","rawOutput":false,"precision":"","retentionPolicy":"","x":1190,"y":460,"wires":[["216f7435.a58a5c","452b20bf.0c77f","df29ab4f.6ec4c8","a13c182c.bb9e28","1c05c7c8.3f7b38","5182850d.06b60c"]]},{"id":"fced4870.bb6b28","type":"ui_ui_control","z":"8d9e59c5.1bb608","name":"","events":"change","x":220,"y":440,"wires":[["5933ae48.f8c16","a18a84b0.913898"]]},{"id":"216f7435.a58a5c","type":"function","z":"8d9e59c5.1bb608","name":"Draw Temperatures","func":"items = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [ \"Gate\", \"UPS\", \"Garage\", \"Water\", \"Clock\", \"Dak\", \"Kitchen\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\ngraph.payload[0].data[3] = []\ngraph.payload[0].data[4] = []\ngraph.payload[0].data[5] = []\ngraph.payload[0].data[6] = []\n\nfor (var i = 0; i < items.length; i++) {\n    series = -1\n    if(items[i].id === \"0\") {\n        series = 0\n        continue; //Discard Gate temperature\n    }\n    if(items[i].id === \"1\")\n        series = 1\n    if(items[i].id === \"5\") {\n        series = 2\n    }\n    if(items[i].id === \"6\")\n        series = 3\n    if(items[i].id === \"7\")\n        series = 4\n    if(items[i].id === \"dc:4f:22:98:04:df\")\n        series = 5\n    if(items[i].id === \"8\")\n        series = 6\n \n    \n    if(series >= 0) {\n        graph.payload[0].data[series].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].T).toFixed(1) } )\n    }\n}\n\n\n\nreturn graph","outputs":1,"noerr":0,"x":1410,"y":360,"wires":[["5414fc4e.0d6ed4"]]},{"id":"452b20bf.0c77f","type":"function","z":"8d9e59c5.1bb608","name":"Draw Power","func":"items = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [\"12V\", \"12A\", \"230V\", \"230A\", \"Geyser\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\ngraph.payload[0].data[3] = []\ngraph.payload[0].data[4] = []\n\nfor (var i = 0; i < items.length; i++) {\n    if(items[i].id === \"1\") {\n        graph.payload[0].data[0].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V0 / 1000 } )\n        graph.payload[0].data[1].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].V1 - 32768) / 1000 } )\n        graph.payload[0].data[2].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V2 / 1000 } )\n        graph.payload[0].data[3].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].V3 - 32768) / 1000 } )\n    }\n    if(items[i].id === \"dc:4f:22:98:04:df\") {\n        graph.payload[0].data[4].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V0} )\n    }\n}\n\nreturn graph","outputs":1,"noerr":0,"x":1390,"y":420,"wires":[["c9018619.9d25b8"]]},{"id":"c9018619.9d25b8","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":20,"width":0,"height":0,"label":"Power","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1610,"y":420,"wires":[[]]},{"id":"5414fc4e.0d6ed4","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":1,"width":0,"height":0,"label":"Temperature","chartType":"line","legend":"true","xformat":"dd HH:mm","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#008000","#aec7e8","#ff7f0e","#0080ff","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1630,"y":360,"wires":[[]]},{"id":"89c5402d.96a3b","type":"function","z":"8e3dae77.2b0e1","name":"Node 3: Fermenter","func":"//Do not send anything, just log\nif(global.get(\"requestedFermenter\") === false)\n{\n    global.set(\"requestedFermenter\", false)\n   return null;\n}\nglobal.set(\"requestedFermenter\", false)\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\nonboard = msg.payload.voltages[0] / 1000;\ntemp0 = msg.payload.voltages[1] / 1000;\ntemp1 = msg.payload.voltages[2] / 1000;\nsetpoint = msg.payload.voltages[3] / 1000;\n\ncooler = \"OFF\";\nif(msg.payload.outputs === 1)\n    cooler = \"ON\"\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Fermenter*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nCooler: \" + cooler + \n              \"\\nCPU: \" + temp.toFixed(2) + \" C\" +\n              //\"\\nonboard: \" + onboard.toFixed(2) + \" C\" +\n              \"\\nsetpoint: \" + setpoint.toFixed(2) + \" C\" +\n              \"\\ntemp0: \" + temp0.toFixed(2) + \" C\" +\n              \"\\ntemp1: \" + temp1.toFixed(2) + \" C\"\n\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":300,"wires":[["9f764455.ac1488"]]},{"id":"80f1ef55.09a96","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"b88984f.d6a7478","order":1,"width":6,"height":6,"label":"Chamber","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"The fermenter has not ever sent me stuff","dot":false,"ymin":"","ymax":"","removeOlder":"12","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1620,"y":480,"wires":[[]]},{"id":"df29ab4f.6ec4c8","type":"function","z":"8d9e59c5.1bb608","name":"Draw Fermenter","func":"items = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [\"CPU\", \"Onboard\", \"T0\", \"T1\", \"Setpoint\", \"Cooler\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\ngraph.payload[0].data[3] = []\ngraph.payload[0].data[4] = []\ngraph.payload[0].data[5] = []\n\nfor (var i = 0; i < items.length; i++) {\n    series = -1\n    if(items[i].id === \"3\")\n        series = 0\n    \n    if(series >= 0) {\n        graph.payload[0].data[0].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].T / 1000 } )\n        graph.payload[0].data[1].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V0 / 1000 } )\n        graph.payload[0].data[2].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V1 / 1000 } )\n        graph.payload[0].data[3].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V2 / 1000 } )\n        graph.payload[0].data[4].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V3 / 1000 } )\n        \n        cooler = items[i].T\n        if(msg.payload.outputs === 1)\n            cooler = (items[i].V3 / 1000 - 5)\n    }\n}\n\nreturn graph","outputs":1,"noerr":0,"x":1400,"y":480,"wires":[["80f1ef55.09a96"]]},{"id":"a13c182c.bb9e28","type":"function","z":"8d9e59c5.1bb608","name":"State to values","func":"function gateStateToNumber (state){\n    switch(state)\n    {\n        case 1:\n            return 0;\n        case 2:\n            return 1;\n        case 3:\n        case 4:\n            return 0.5;\n        case 5:\n        case 6:\n        case 7:\n        case 8:\n            return -1;\n        default:\n            return -1;\n            \n    }\n}\n\nfunction doorStateToNumber (state){\n    switch(state)\n    {\n        default:\n        case 1: //Closed\n            return 0;\n        case 2: //moving\n            return 0.5;\n        case 3: //Open\n            return 1;\n    }\n}\n\nitems = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [\"Street\", \"House\", \"Left\", \"Right\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\ngraph.payload[0].data[3] = []\n\nfor (var i = 0; i < items.length; i++) {\n    if(items[i].id === \"0\") {\n        graph.payload[0].data[0].push( { \"x\": Date.parse(items[i].time), \"y\": gateStateToNumber(items[i].V1) } )\n    }\n    if(items[i].id === \"4\") {\n        graph.payload[0].data[1].push( { \"x\": Date.parse(items[i].time), \"y\": gateStateToNumber(items[i].V0) } )\n    }\n    if(items[i].id === \"5\") {\n        graph.payload[0].data[2].push( { \"x\": Date.parse(items[i].time), \"y\": doorStateToNumber(items[i].V0) } )\n        graph.payload[0].data[3].push( { \"x\": Date.parse(items[i].time), \"y\": doorStateToNumber(items[i].V1) } )\n        continue\n    }\n}\n\nreturn graph","outputs":1,"noerr":0,"x":1400,"y":540,"wires":[["c2dddfd0.6a82a"]]},{"id":"c2dddfd0.6a82a","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":22,"width":0,"height":0,"label":"GateStates","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"step","nodata":"","dot":false,"ymin":"0","ymax":"1.5","removeOlder":"8","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1630,"y":540,"wires":[[]]},{"id":"7a4c91ca.b7e58","type":"ui_button","z":"8d9e59c5.1bb608","name":"24_btn","group":"a7800071.8aa72","order":3,"width":2,"height":1,"passthru":false,"label":"24H","tooltip":"Plots only todays values","color":"","bgcolor":"","icon":"","payload":"","payloadType":"date","topic":"","x":210,"y":500,"wires":[["a9514614.0327f8"]]},{"id":"a9514614.0327f8","type":"function","z":"8d9e59c5.1bb608","name":"Query todays values","func":"msg.duration = 24\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":500,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"29867bc1.7b5394","type":"function","z":"8d9e59c5.1bb608","name":"Query last 12H values","func":"msg.duration = 12\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":540,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"7a59bb84.6c9f34","type":"ui_button","z":"8d9e59c5.1bb608","name":"12_btn","group":"a7800071.8aa72","order":4,"width":2,"height":1,"passthru":false,"label":"12 H","tooltip":"Show last 12 Hours","color":"","bgcolor":"","icon":"","payload":"","payloadType":"date","topic":"","x":210,"y":540,"wires":[["29867bc1.7b5394"]]},{"id":"ecc8ef02.575c5","type":"function","z":"8d9e59c5.1bb608","name":"Query last 8h values","func":"msg.duration = 8\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":580,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"cc57ed0b.ee94c","type":"ui_button","z":"8d9e59c5.1bb608","name":"8_btn","group":"a7800071.8aa72","order":5,"width":2,"height":1,"passthru":false,"label":"8H","tooltip":"Show last 6 Hours","color":"","bgcolor":"","icon":"","payload":"","payloadType":"date","topic":"","x":210,"y":580,"wires":[["ecc8ef02.575c5"]]},{"id":"72613977.e7f4c8","type":"influxdb in","z":"8e3dae77.2b0e1","influxdb":"66c477f.2ecc188","name":"Query Street","query":" select * from nodes where id='0' ORDER BY time DESC limit 1","rawOutput":false,"precision":"","retentionPolicy":"","x":710,"y":120,"wires":[["737587d5.a5a458"]]},{"id":"87a8241f.ce7268","type":"influxdb in","z":"8e3dae77.2b0e1","influxdb":"66c477f.2ecc188","name":"Query House","query":" select * from nodes where id='4' ORDER BY time DESC limit 1","rawOutput":false,"precision":"","retentionPolicy":"","x":1030,"y":120,"wires":[["f502d627.6cfbd8"]]},{"id":"737587d5.a5a458","type":"function","z":"8e3dae77.2b0e1","name":"Keep street","func":"street = msg.payload\nmsg = {}\nmsg.street = street\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":120,"wires":[["87a8241f.ce7268"]]},{"id":"f7cdf8d0.a5f2c8","type":"function","z":"8d9e59c5.1bb608","name":"Build Query","func":"time = -1\nif(msg.hasOwnProperty(\"duration\"))\n    time = msg.duration\n\nclock_sw = flow.get(\"clock\") || 0\ngeyser_sw = flow.get(\"geyser\") || 0\nwater_sw = flow.get(\"water\") || 0\nups_sw = flow.get(\"ups\") || 0\ngarage_sw = flow.get(\"garage\") || 0\nkitchen_sw = flow.get(\"kitchen\") || 0\n\n//always include House Power\nid_condition = \"id = '84:0d:8e:57:41:92' or id = '0' or id = '9' or id = '10' or id = '11' \"\n\nif(kitchen_sw) {\n    id_condition += \"or id = '8' \"\n}\nif(clock_sw) {\n    id_condition += \"or id = '7' \"\n}\nif(geyser_sw) {\n    id_condition += \"or id = 'dc:4f:22:98:04:df' \"\n}\nif(water_sw) {\n    id_condition += \"or id = '6' \"\n}\nif(ups_sw) {\n    id_condition += \"or id = '1' \"\n}\nif(garage_sw) {\n    id_condition += \"or id = '5' \"\n}\n\n\nif((time > 0) && (id_condition.length > 0)) {\n    msg.query = \"SELECT * from nodes where time > now() - \" + time + \"h and \" + id_condition + \" ORDER BY time DESC limit 2000\"\n    return msg    \n}\n\n// if(time > 0) {\n//     msg.query = \"SELECT * from nodes where time > now() - \" + time + \"h ORDER BY time DESC limit 2000\"\n//     return msg\n// }\n\n// if(id_condition.length > 0) {\n//     msg.query = \"SELECT * from nodes where \" + id_condition + \" ORDER BY time DESC limit 2000\"\n//     return msg\n// }\n\nmsg.query = \"SELECT * from nodes where \" + id_condition + \" ORDER BY time DESC limit 2000\"\n// msg.query = \"SELECT * from nodes ORDER BY time DESC limit 2000\"\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":460,"wires":[["c75ceba6.731908"]]},{"id":"5f091d19.fd6434","type":"ui_switch","z":"8d9e59c5.1bb608","name":"clock_sw","label":"Clock","tooltip":"","group":"a7800071.8aa72","order":14,"width":2,"height":1,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":620,"y":100,"wires":[["3bbb447.93474bc"]]},{"id":"3a53c31.481aa3c","type":"ui_switch","z":"8d9e59c5.1bb608","name":"geyser_sw","label":"Geyser","tooltip":"","group":"a7800071.8aa72","order":8,"width":2,"height":1,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":630,"y":160,"wires":[["9af0abf4.194298"]]},{"id":"5933ae48.f8c16","type":"function","z":"8d9e59c5.1bb608","name":"was change","func":"if((msg.payload === \"change\") && (msg.tab === 0)) {\n    msg.payload = true\n    return msg\n}\n    \nreturn null","outputs":1,"noerr":0,"x":450,"y":440,"wires":[["5f091d19.fd6434","3a53c31.481aa3c","8d3733ad.c0bd5","27c7ad03.a8d2e2","f161b986.0c5018","f7cdf8d0.a5f2c8","70de31f4.a41a6","c9b7bf35.32ecc"]]},{"id":"8d3733ad.c0bd5","type":"ui_switch","z":"8d9e59c5.1bb608","name":"water_sw","label":"Water","tooltip":"","group":"a7800071.8aa72","order":15,"width":2,"height":1,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":620,"y":220,"wires":[["67ff3fe0.39005"]]},{"id":"3bbb447.93474bc","type":"function","z":"8d9e59c5.1bb608","name":"set clock","func":"flow.set(\"clock\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":100,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"9af0abf4.194298","type":"function","z":"8d9e59c5.1bb608","name":"set geyser","func":"flow.set(\"geyser\", msg.payload)\n\nreturn msg","outputs":1,"noerr":0,"x":810,"y":160,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"67ff3fe0.39005","type":"function","z":"8d9e59c5.1bb608","name":"set water","func":"flow.set(\"water\", msg.payload)\n\nreturn msg","outputs":1,"noerr":0,"x":800,"y":220,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"27c7ad03.a8d2e2","type":"ui_switch","z":"8d9e59c5.1bb608","name":"ups_sw","label":"UPS","tooltip":"","group":"a7800071.8aa72","order":10,"width":2,"height":1,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":620,"y":280,"wires":[["9406cdf0.79e0f"]]},{"id":"9406cdf0.79e0f","type":"function","z":"8d9e59c5.1bb608","name":"set ups","func":"flow.set(\"ups\", msg.payload)\n\nreturn msg","outputs":1,"noerr":0,"x":800,"y":280,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"f161b986.0c5018","type":"ui_switch","z":"8d9e59c5.1bb608","name":"garage_sw","label":"Garage","tooltip":"","group":"a7800071.8aa72","order":9,"width":2,"height":1,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":630,"y":340,"wires":[["9a26c934.0c8c68"]]},{"id":"9a26c934.0c8c68","type":"function","z":"8d9e59c5.1bb608","name":"set garage","func":"flow.set(\"garage\", msg.payload)\n\nreturn msg","outputs":1,"noerr":0,"x":810,"y":340,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"3725964a.b8c9da","type":"comment","z":"8e3dae77.2b0e1","name":"Node 4: House","info":"","x":880,"y":340,"wires":[]},{"id":"b22a00c4.a4a63","type":"ui_ui_control","z":"8bca10f1.5dd4c","name":"","events":"change","x":380,"y":220,"wires":[["2c7b7378.cb8cdc"]]},{"id":"17551b69.60cd45","type":"ui_gauge","z":"8bca10f1.5dd4c","name":"alloc_gauge","group":"60339c65.a26d34","order":1,"width":0,"height":0,"gtype":"gage","title":"Allocated","label":"%","format":"{{value | number:1}}","min":"0","max":"100","colors":["#3406ea","#00b700","#ca3838"],"seg1":"","seg2":"","x":1130,"y":180,"wires":[]},{"id":"47ae01ac.5ebc6","type":"influxdb in","z":"8bca10f1.5dd4c","influxdb":"9818fae6.808138","name":"Query Memory","query":"SELECT Alloc, TotalAlloc, HeapSys, Sys FROM \"runtime\" ORDER BY time DESC LIMIT 1","rawOutput":false,"precision":"","retentionPolicy":"","x":740,"y":220,"wires":[["c3409d44.a544a","77a279d0.955e38"]]},{"id":"c3409d44.a544a","type":"function","z":"8bca10f1.5dd4c","name":"Get allocated","func":"allocated = msg.payload[0].Alloc\nmax = msg.payload[0].HeapSys\n\nreturn [\n        {\"payload\":(allocated / max) * 100},\n        {\"payload\":allocated / 1e6},\n        {\"payload\":max / 1e6}\n        ]","outputs":3,"noerr":0,"x":930,"y":220,"wires":[["17551b69.60cd45"],["f0abf1a.5319b1"],["aacf9f1.339f06"]]},{"id":"596e2f4a.236a7","type":"ui_gauge","z":"8bca10f1.5dd4c","name":"system_gauge","group":"60339c65.a26d34","order":4,"width":0,"height":0,"gtype":"gage","title":"System","label":"%","format":"{{value | number:1}}","min":0,"max":"100","colors":["#3406ea","#00b700","#ca3838"],"seg1":"","seg2":"","x":1140,"y":320,"wires":[]},{"id":"77a279d0.955e38","type":"function","z":"8bca10f1.5dd4c","name":"Get System","func":"allocated = msg.payload[0].Sys\nmax = msg.payload[0].TotalAlloc\n\nreturn [\n        {\"payload\":(allocated / max) * 100},\n        {\"payload\":allocated / 1e6},\n        {\"payload\":max / 1e6}\n        ]","outputs":3,"noerr":0,"x":930,"y":360,"wires":[["596e2f4a.236a7"],["365d610a.d7e7fe"],["246f663b.afefea"]]},{"id":"365d610a.d7e7fe","type":"ui_text","z":"8bca10f1.5dd4c","group":"60339c65.a26d34","order":5,"width":0,"height":0,"name":"alloc_system","label":"System Alocated","format":"{{msg.payload | number:3}} MB","layout":"row-spread","x":1130,"y":360,"wires":[]},{"id":"31ac1846.eb5808","type":"influxdb in","z":"8bca10f1.5dd4c","influxdb":"9818fae6.808138","name":"Query Node Disk","query":"SELECT \"path\", diskBytes from \"shard\" WHERE \"database\"='erasmus_home' ORDER BY time DESC LIMIT 1","rawOutput":false,"precision":"","retentionPolicy":"","x":750,"y":520,"wires":[["79759f6d.baaad"]]},{"id":"79759f6d.baaad","type":"function","z":"8bca10f1.5dd4c","name":"Get Node Size","func":"allocated = msg.payload[0].diskBytes\nmsg.payload = allocated / 1e6\n\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":520,"wires":[["aa153a5a.9c1798"]]},{"id":"aa153a5a.9c1798","type":"ui_text","z":"8bca10f1.5dd4c","group":"60339c65.a26d34","order":10,"width":0,"height":0,"name":"erasmus_disk","label":"Node Disk","format":"{{msg.payload | number:3}} MB","layout":"row-spread","x":1140,"y":520,"wires":[]},{"id":"7c567b58.3717a4","type":"influxdb in","z":"8bca10f1.5dd4c","influxdb":"9818fae6.808138","name":"Query Monitor Disk","query":"SELECT \"path\", diskBytes from \"shard\" WHERE \"database\"='_internal' ORDER BY time DESC LIMIT 1","rawOutput":false,"precision":"","retentionPolicy":"","x":750,"y":560,"wires":[["9f06f0eb.51c98"]]},{"id":"9f06f0eb.51c98","type":"function","z":"8bca10f1.5dd4c","name":"Get Monitor Size","func":"allocated = msg.payload[0].diskBytes\nmsg.payload = allocated / 1e6\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":560,"wires":[["bbc5776.25c6188"]]},{"id":"bbc5776.25c6188","type":"ui_text","z":"8bca10f1.5dd4c","group":"60339c65.a26d34","order":11,"width":0,"height":0,"name":"monitor_disk","label":"Monitor Disk","format":"{{msg.payload | number:3}} MB","layout":"row-spread","x":1130,"y":560,"wires":[]},{"id":"70de31f4.a41a6","type":"debug","z":"8d9e59c5.1bb608","name":"Graphs","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":620,"y":40,"wires":[]},{"id":"2c7b7378.cb8cdc","type":"function","z":"8bca10f1.5dd4c","name":"was change","func":"if((msg.payload === \"change\") && (msg.tab === 2)) {\n    msg.payload = true\n    return msg\n}\n    \nreturn null","outputs":1,"noerr":0,"x":550,"y":220,"wires":[["47ae01ac.5ebc6","31ac1846.eb5808","7c567b58.3717a4","f010537d.e3204"]]},{"id":"f0abf1a.5319b1","type":"ui_text","z":"8bca10f1.5dd4c","group":"60339c65.a26d34","order":2,"width":0,"height":0,"name":"alloc_heap","label":"Heap Alocated","format":"{{msg.payload | number:3}} MB","layout":"row-spread","x":1130,"y":220,"wires":[]},{"id":"aacf9f1.339f06","type":"ui_text","z":"8bca10f1.5dd4c","group":"60339c65.a26d34","order":3,"width":0,"height":0,"name":"total_heap","label":"Heap Total Alocatable","format":"{{msg.payload | number:3}} MB","layout":"row-spread","x":1130,"y":260,"wires":[]},{"id":"246f663b.afefea","type":"ui_text","z":"8bca10f1.5dd4c","group":"60339c65.a26d34","order":6,"width":0,"height":0,"name":"total_system","label":"System Total Alocatable","format":"{{msg.payload | number:3}} MB","layout":"row-spread","x":1130,"y":400,"wires":[]},{"id":"f010537d.e3204","type":"influxdb in","z":"8bca10f1.5dd4c","influxdb":"66c477f.2ecc188","name":"Query data points","query":"SELECT count(\"T\") from nodes","rawOutput":false,"precision":"","retentionPolicy":"","x":750,"y":460,"wires":[["944fdab6.970488"]]},{"id":"944fdab6.970488","type":"function","z":"8bca10f1.5dd4c","name":"Get Measurements","func":"msg.payload = msg.payload[0].count\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":460,"wires":[["37a802a8.b7cabe"]]},{"id":"37a802a8.b7cabe","type":"ui_text","z":"8bca10f1.5dd4c","group":"60339c65.a26d34","order":8,"width":0,"height":0,"name":"measurement_points","label":"Measurements","format":"{{msg.payload}}","layout":"row-spread","x":1160,"y":460,"wires":[]},{"id":"77a3da52.8f34a4","type":"inject","z":"8e3dae77.2b0e1","name":"","topic":"","payload":"Hi","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":930,"y":740,"wires":[["9f764455.ac1488"]]},{"id":"c5e0cb36.3d3788","type":"function","z":"8e3dae77.2b0e1","name":"Node 8: Kitchen","func":"is_sample = ((msg.payload.inputs & 0x02) === 0x02);\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*Kitchen*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n   \nreturn msg","outputs":1,"noerr":0,"x":880,"y":500,"wires":[["9f764455.ac1488"]]},{"id":"c9b7bf35.32ecc","type":"ui_switch","z":"8d9e59c5.1bb608","name":"kitchen_sw","label":"Kitchen","tooltip":"","group":"a7800071.8aa72","order":13,"width":2,"height":1,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":630,"y":400,"wires":[["1e2ecefd.cb6691"]]},{"id":"1e2ecefd.cb6691","type":"function","z":"8d9e59c5.1bb608","name":"set kitchen","func":"flow.set(\"kitchen\", msg.payload)\n\nreturn msg","outputs":1,"noerr":0,"x":810,"y":400,"wires":[["f7cdf8d0.a5f2c8"]]},{"id":"ab5bbee.4dbbd4","type":"mqtt out","z":"983d8884.0e0c58","name":"Send to Lamps","topic":"/down/esp/dc:4f:22:f6:ce:75","qos":"","retain":"","broker":"4a731906.628d48","x":740,"y":780,"wires":[]},{"id":"a20061a2.b3874","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":18,"width":0,"height":0,"label":"House","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1610,"y":600,"wires":[[]]},{"id":"1c05c7c8.3f7b38","type":"function","z":"8d9e59c5.1bb608","name":"Draw House Power","func":"items = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [\"V\", \"A\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\n\nfor (var i = 0; i < items.length; i++) {\n    if(items[i].id === \"84:0d:8e:57:41:92\") {\n        graph.payload[0].data[0].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].V0 / 10).toFixed(2)} )\n        graph.payload[0].data[1].push( { \"x\": Date.parse(items[i].time), \"y\": items[i].V1} )\n    }\n}\n\nreturn graph","outputs":1,"noerr":0,"x":1410,"y":600,"wires":[["a20061a2.b3874"]]},{"id":"961bcf94.ed0dd","type":"ui_chart","z":"8d9e59c5.1bb608","name":"","group":"a7800071.8aa72","order":23,"width":0,"height":0,"label":"Node 9, 10 & 11","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"20","ymax":"33","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1640,"y":660,"wires":[[]]},{"id":"5182850d.06b60c","type":"function","z":"8d9e59c5.1bb608","name":"Draw Node 9 & 10","func":"items = msg.payload\n\ngraph = {}\ngraph.payload = []\ngraph.payload[0] = {}\ngraph.payload[0].series = [\"T9\", \"T10\", \"T11\"]\ngraph.payload[0].labels = [\"\"]\ngraph.payload[0].data = []\ngraph.payload[0].data[0] = []\ngraph.payload[0].data[1] = []\ngraph.payload[0].data[2] = []\n\nfor (var i = 0; i < items.length; i++) {\n    if(items[i].id === \"9\") {\n        graph.payload[0].data[0].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].T).toFixed(3)} )\n    }\n    if(items[i].id === \"10\") {\n        graph.payload[0].data[1].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].T).toFixed(3)} )\n    }\n    if(items[i].id === \"11\") {\n        graph.payload[0].data[2].push( { \"x\": Date.parse(items[i].time), \"y\": (items[i].T).toFixed(3)} )\n    }\n}\n\nreturn graph","outputs":1,"noerr":0,"x":1410,"y":660,"wires":[["961bcf94.ed0dd"]]},{"id":"1a9d5b2e.e1e3b5","type":"debug","z":"32ef613c.4a13ee","name":"GoogleHome","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":630,"y":540,"wires":[]},{"id":"7637143d.af5c2c","type":"google-home","z":"32ef613c.4a13ee","conf":"f966ca01.f24958","device":"3416","acknowledge":true,"name":"Water","topic":"","x":430,"y":540,"wires":[["1a9d5b2e.e1e3b5"]]},{"id":"6e86b0b8.e4995","type":"google-home","z":"32ef613c.4a13ee","conf":"f966ca01.f24958","device":"3417","acknowledge":true,"name":"Lamps","topic":"","x":430,"y":600,"wires":[["1a9d5b2e.e1e3b5","53c0276f.7092e8"]]},{"id":"a919762f.4e3158","type":"mqtt out","z":"32ef613c.4a13ee","name":"Send to Lamps","topic":"/down/esp/dc:4f:22:f6:ce:75","qos":"","retain":"","broker":"4a731906.628d48","x":940,"y":580,"wires":[]},{"id":"53c0276f.7092e8","type":"function","z":"32ef613c.4a13ee","name":"Parse Lamps","func":"lamps = null\ndown_lights = null\n\n\nif(global.get('light_state') === undefined){\n    global.set('light_state', 'off')\n}\n\nfunction set_down_lights(state){\n    current_light = global.get('light_state');\n    \n    if(state === true){\n        if(current_light == \"off\"){\n            global.set('light_state', 'on')\n            \n            mqtt_msg = {}\n            mqtt_msg.topic = \"/node/down/2\";\n            mqtt_msg.payload = \"l 1\";\n            node.send([null, mqtt_msg])\n        }\n    }else{\n        if(current_light == \"on\"){\n            global.set('light_state', 'off')\n            \n            mqtt_msg = {}\n            mqtt_msg.topic = \"/node/down/2\";\n            mqtt_msg.payload = \"l 1\";\n            node.send([null, mqtt_msg])\n        }\n    }\n}\n\n\nif(msg.name == \"Lamps\"){\n    command = msg.payload.command.split(\".\")[3]\n    if(command == \"BrightnessAbsolute\"){\n        brightness = msg.payload.params.brightness\n        //switch down lights on\n        set_down_lights(true)\n        \n        if(brightness < 50){\n            //switch downlight to TV\n            down_lights = 2\n        }else{\n            //switch downlight to normal\n            down_lights = 0\n        }\n        \n    }\n    if(command == \"OnOff\"){\n        lamps = {}\n        light_on = msg.payload.params.on\n        if(light_on === false){\n            lamps.payload = \"reset\"\n            \n            //switch down lights off\n            set_down_lights(false)\n        }else{\n            lamps.payload = \"set\"\n            \n            //switch down lights on\n            set_down_lights(true)\n        }\n    }\n}\n\nmqtt_msg = null\nif(down_lights !== null){\n    mqtt_msg = {}\n    mqtt_msg.topic = \"/node/down/2\";\n    mqtt_msg.payload = \"l \" + down_lights;\n}\n\nreturn [lamps, mqtt_msg];","outputs":2,"noerr":0,"x":630,"y":600,"wires":[["a919762f.4e3158"],["7f8b4a2d.200ed4"]]},{"id":"7f8b4a2d.200ed4","type":"mqtt out","z":"32ef613c.4a13ee","name":"","topic":"","qos":"","retain":"","broker":"4a731906.628d48","x":910,"y":640,"wires":[]},{"id":"64da20.e71665e","type":"debug","z":"983d8884.0e0c58","name":"Node2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":980,"y":720,"wires":[]},{"id":"db688881.294008","type":"function","z":"8e3dae77.2b0e1","name":"Node 9: IO Node","func":"is_sample = ((msg.payload.inputs & 0x02) === 0x02);\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*IO Node 9*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n   \nreturn msg","outputs":1,"noerr":0,"x":890,"y":540,"wires":[["9f764455.ac1488"]]},{"id":"4d2ff602.352828","type":"function","z":"8e3dae77.2b0e1","name":"Node 10: IO Node","func":"is_sample = ((msg.payload.inputs & 0x02) === 0x02);\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*IO Node 10*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n   \nreturn msg","outputs":1,"noerr":0,"x":890,"y":580,"wires":[["9f764455.ac1488"]]},{"id":"6dc68748.d26558","type":"function","z":"8e3dae77.2b0e1","name":"Node 11: IO Node","func":"is_sample = ((msg.payload.inputs & 0x02) === 0x02);\n\n//do not send a telegram when this is a sample message\nif(is_sample == 1)\n{\n    return null\n}\n\nupTime = msg.payload.uptime / 60000;\ntemp = msg.payload.temperature;\n    \nfunction minutesToString(minFloat)\n{\n    now = minFloat * 60;\n\tif(now < 60)\n\t{\n\t\treturn  Math.round(now) + \"s\";\n\t}\n\telse\n\t{\n\t\tmin = now / 60;\n\t\tnow %= 60;\n\t\tif(min < 60)\n\t\t{\n\t\t\treturn Math.round(min) + \"m \" + Math.round(now) + \"s\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\thour = min / 60;\n\t\t\tmin %= 60;\n\t\t\tif(hour < 24)\n\t\t\t{\n\t\t\t\treturn Math.round(hour) + \"h \" + Math.round(min) + \"m \" + Math.round(min) + \"s\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tday = hour / 24;\n\t\t\t\thour %= 24;\n\t\t\t\treturn Math.round(day) + \"d\" + Math.round(hour) + \"h\" + Math.round(min) + \"m\" + Math.round(now) + \"s\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nupTime = minutesToString(upTime);\n\nmsg.payload = \"*IO Node 11*\" +\n              \"\\nUp time: \" + upTime + \n              \"\\nT: \" + temp.toFixed(2) + \" C\"\n   \nreturn msg","outputs":1,"noerr":0,"x":890,"y":620,"wires":[["9f764455.ac1488"]]},{"id":"a18a84b0.913898","type":"function","z":"8d9e59c5.1bb608","name":"Query last values","func":"//Only retreive when overview tab selected\nif(msg.tab == 1){\n    \n    // Retrieve UPS \n    msg = {\n        query: \"SELECT * from nodes WHERE id='1' ORDER BY time DESC limit 1\"\n    }\n    node.send(msg)\n    \n    // Retrieve Garage\n    msg = {\n        query: \"SELECT * from nodes WHERE id='5' ORDER BY time DESC limit 1\"\n    }\n    node.send(msg)\n    \n    // Retrieve Water\n    msg = {\n        query: \"SELECT * from nodes WHERE id='6' ORDER BY time DESC limit 1\"\n    }\n    node.send(msg)\n    \n    // Retrieve Clock\n    msg = {\n        query: \"SELECT * from nodes WHERE id='7' ORDER BY time DESC limit 1\"\n    }\n    node.send(msg)\n    \n    // Retrieve Geyser\n    msg = {\n        query: \"SELECT * from nodes WHERE id='dc:4f:22:98:04:df' ORDER BY time DESC limit 1\"\n    }\n    node.send(msg)\n    \n    // Retrieve Kitchen\n    msg = {\n        query: \"SELECT * from nodes WHERE id='8' ORDER BY time DESC limit 1\"\n    }\n\n    return msg;\n}\n\nreturn null;","outputs":1,"noerr":0,"x":410,"y":680,"wires":[["af15341.e0a11c8"]]},{"id":"af15341.e0a11c8","type":"influxdb in","z":"8d9e59c5.1bb608","influxdb":"66c477f.2ecc188","name":"Query Nodes","query":"SELECT * from nodes ORDER BY time DESC limit 3","rawOutput":false,"precision":"","retentionPolicy":"","x":610,"y":680,"wires":[["6e83608f.3e541"]]},{"id":"6e83608f.3e541","type":"switch","z":"8d9e59c5.1bb608","name":"","property":"payload[0].id","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"5","vt":"str"},{"t":"eq","v":"6","vt":"str"},{"t":"eq","v":"7","vt":"str"},{"t":"eq","v":"dc:4f:22:98:04:df","vt":"str"},{"t":"eq","v":"8","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":770,"y":680,"wires":[["1c105d4f.3e23e3"],["d841eb3f.4741f8"],["eff6dfbc.239d8"],["e18f07a8.f4dd38"],["f8be3521.2f7168"],["4fa6d2ad.e0322c"]]},{"id":"1c105d4f.3e23e3","type":"function","z":"8d9e59c5.1bb608","name":"Get Temp","func":"temp = msg.payload[0].T\n\nmsg = {\n    payload: temp\n}\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":640,"wires":[["40ba3614.381708"]]},{"id":"40ba3614.381708","type":"ui_gauge","z":"8d9e59c5.1bb608","name":"","group":"387c7f87.6a23f","order":5,"width":2,"height":2,"gtype":"gage","title":"UPS","label":"C","format":"{{value | number:1}}","min":"10","max":"50","colors":["#5396ee","#00e639","#ca3838"],"seg1":"","seg2":"","x":1130,"y":640,"wires":[]},{"id":"b5cf122d.eff38","type":"ui_gauge","z":"8d9e59c5.1bb608","name":"","group":"387c7f87.6a23f","order":4,"width":2,"height":2,"gtype":"gage","title":"Garage","label":"C","format":"{{value | number:1}}","min":"10","max":"50","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1140,"y":680,"wires":[]},{"id":"bd660a32.221c38","type":"ui_gauge","z":"8d9e59c5.1bb608","name":"","group":"387c7f87.6a23f","order":3,"width":2,"height":2,"gtype":"gage","title":"Water","label":"C","format":"{{value | number:1}}","min":"10","max":"50","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1130,"y":720,"wires":[]},{"id":"5b2264a7.bbcf1c","type":"ui_gauge","z":"8d9e59c5.1bb608","name":"","group":"387c7f87.6a23f","order":2,"width":0,"height":0,"gtype":"gage","title":"Clock","label":"C","format":"{{value | number:1}}","min":"10","max":"50","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1130,"y":760,"wires":[]},{"id":"bbb2ea5d.aad548","type":"ui_gauge","z":"8d9e59c5.1bb608","name":"","group":"387c7f87.6a23f","order":6,"width":2,"height":2,"gtype":"gage","title":"Dak","label":"C","format":"{{value | number:1}}","min":"10","max":"50","colors":["#0098b3","#18c94d","#ca3838"],"seg1":"","seg2":"","x":1130,"y":800,"wires":[]},{"id":"a59940a.b7491c","type":"ui_gauge","z":"8d9e59c5.1bb608","name":"","group":"387c7f87.6a23f","order":1,"width":0,"height":0,"gtype":"gage","title":"Kitchen","label":"C","format":"{{value | number:1}}","min":"10","max":"50","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1140,"y":840,"wires":[]},{"id":"d841eb3f.4741f8","type":"function","z":"8d9e59c5.1bb608","name":"Get Temp","func":"temp = msg.payload[0].T\n\nmsg = {\n    payload: temp\n}\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":680,"wires":[["b5cf122d.eff38"]]},{"id":"eff6dfbc.239d8","type":"function","z":"8d9e59c5.1bb608","name":"Get Temp","func":"temp = msg.payload[0].T\n\nmsg = {\n    payload: temp\n}\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":720,"wires":[["bd660a32.221c38"]]},{"id":"e18f07a8.f4dd38","type":"function","z":"8d9e59c5.1bb608","name":"Get Temp","func":"temp = msg.payload[0].T\n\nmsg = {\n    payload: temp\n}\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":760,"wires":[["5b2264a7.bbcf1c"]]},{"id":"f8be3521.2f7168","type":"function","z":"8d9e59c5.1bb608","name":"Get Temp","func":"temp = msg.payload[0].T\n\nmsg = {\n    payload: temp\n}\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":800,"wires":[["bbb2ea5d.aad548"]]},{"id":"4fa6d2ad.e0322c","type":"function","z":"8d9e59c5.1bb608","name":"Get Temp","func":"temp = msg.payload[0].T\n\nmsg = {\n    payload: temp\n}\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":840,"wires":[["a59940a.b7491c"]]}]